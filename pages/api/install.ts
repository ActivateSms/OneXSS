import type { NextRequest } from "next/server";
import {passwordHash } from "../../common/auth"
import { Buffer } from 'buffer';

export const config = { runtime: "edge" };

// 数据库初始化
async function DBInitial(username: string, password: string, useremail: string, domain:string, module_import:boolean) {
    let db_init_sql = `DROP TABLE IF EXISTS invites;
    DROP TABLE IF EXISTS accesslog;
    DROP TABLE IF EXISTS project_modules;
    DROP TABLE IF EXISTS projects;
    DROP TABLE IF EXISTS modules;
    DROP TABLE IF EXISTS users;
    DROP TABLE IF EXISTS config;
    CREATE TABLE users (userid INTEGER AUTO_INCREMENT PRIMARY KEY UNIQUE NOT NULL,username TEXT UNIQUE,password TEXT,useremail TEXT,usertype INTEGER DEFAULT 0,enabled INTEGER DEFAULT 1);
    CREATE TABLE invites(invitecode TEXT PRIMARY KEY UNIQUE NOT NULL,is_used INTEGER DEFAULT 0,create_userid INTEGER,signup_userid INTEGER,FOREIGN KEY (create_userid) REFERENCES users(userid) ON DELETE CASCADE,FOREIGN KEY (signup_userid) REFERENCES users(userid) ON DELETE CASCADE);
    CREATE TABLE modules (moduleid INTEGER AUTO_INCREMENT PRIMARY KEY UNIQUE NOT NULL,modulename TEXT,moduledescription TEXT,moduletype INTEGER DEFAULT 0,modulecontent TEXT,module_extra_enable INTEGER DEFAULT 0,module_extra_argname TEXT UNIQUE,module_extra_column_name TEXT,module_extra_func_name TEXT UNIQUE,userid INTEGER,FOREIGN KEY (userid) REFERENCES users(userid) ON DELETE SET NULL);
    CREATE TABLE projects(projectid INTEGER AUTO_INCREMENT PRIMARY KEY UNIQUE NOT NULL,projectname TEXT,projectdescription TEXT,projectcode TEXT,projecturl CHAR(4) UNIQUE NOT NULL,obfuscate_enable INTEGER DEFAULT 0,obfuscate_code TEXT,telegram_notice_enable INTEGER DEFAULT 0,telegram_notice_token TEXT DEFAULT NULL,telegram_notice_chatid TEXT DEFAULT NULL,enabled INTEGER DEFAULT 1,userid INTEGER,FOREIGN KEY (userid) REFERENCES users(userid) ON DELETE CASCADE);
    CREATE TABLE project_modules (projectid INTEGER,moduleid INTEGER,FOREIGN KEY (projectid) REFERENCES projects(projectid) ON DELETE CASCADE,FOREIGN KEY (moduleid) REFERENCES modules(moduleid) ON DELETE CASCADE);
    CREATE TABLE accesslog (id TEXT PRIMARY KEY UNIQUE NOT NULL,projecturl CHAR(4) NOT NULL,country TEXT,region TEXT,city TEXT,isp TEXT,latitude NUMBER,longitude NUMBER,referer TEXT,domain TEXT,ip TEXT,useragent TEXT,requestdate INTEGER,otherdata TEXT,FOREIGN KEY (projecturl) REFERENCES projects(projecturl) ON DELETE CASCADE);
    CREATE TABLE config(configname TEXT PRIMARY KEY UNIQUE NOT NULL,configvalue TEXT NOT NULL);
    INSERT INTO users (userid,username,password,useremail,usertype,enabled) VALUES(1,'${username}','${password}','${useremail}',1,1);
    INSERT INTO config (configname, configvalue) VALUES ('domain', '${domain}'),('installed', 'installed');
    `;
    if (module_import){
        const module_import_b64_data = "SU5TRVJUIElOVE8gbW9kdWxlcyBWQUxVRVMoMSwn6I635Y+W572R6aG157yW56CBJywn6I635Y+W572R6aG157yW56CBJywxLHJlcGxhY2UoJ2Z1bmN0aW9uIGdldENoYXJTZXQoKXtcbiAgICByZXR1cm4gZG9jdW1lbnQuY2hhcmFjdGVyU2V0O1xufScsJ1xuJyxjaGFyKDEwKSksMSwnY2hhcnNldCcsJ+e8lueggScsJ2dldENoYXJTZXQnLDEpOwpJTlNFUlQgSU5UTyBtb2R1bGVzIFZBTFVFUygyLCfojrflj5bnvZHpobXmoIfpopgnLCfojrflj5bnvZHpobXmoIfpopgnLDEscmVwbGFjZSgnZnVuY3Rpb24gZ2V0VGl0bGUoKXtcbiAgICByZXR1cm4gZG9jdW1lbnQudGl0bGU7XG59JywnXG4nLGNoYXIoMTApKSwxLCd0aXRsZScsJ+agh+mimCcsJ2dldFRpdGxlJywxKTsKSU5TRVJUIElOVE8gbW9kdWxlcyBWQUxVRVMoMywn6I635Y+W572R6aG15rqQ56CBJywn6I635Y+W572R6aG15rqQ56CBJywxLHJlcGxhY2UoJ2Z1bmN0aW9uIGdldEhUTUxTUkMoKXtcbiAgICByZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm91dGVySFRNTDtcbn1cbicsJ1xuJyxjaGFyKDEwKSksMSwnaHRtbHNyYycsJ+a6kOeggScsJ2dldEhUTUxTUkMnLDEpOwpJTlNFUlQgSU5UTyBtb2R1bGVzIFZBTFVFUyg0LCfojrflj5ZDb29raWUnLCfojrflj5Zjb29raWUnLDEscmVwbGFjZSgnZnVuY3Rpb24gZ2V0Q29va2llKCl7XG4gICAgcmV0dXJuIGRvY3VtZW50LmNvb2tpZTtcbn0nLCdcbicsY2hhcigxMCkpLDEsJ2Nvb2tpZScsJ2Nvb2tpZScsJ2dldENvb2tpZScsMSk7CklOU0VSVCBJTlRPIG1vZHVsZXMgVkFMVUVTKDUsJ+iOt+WPluWxj+W5leaIquWbvicsJ+iOt+WPluWxj+W5leaIquWbvicsMSxyZXBsYWNlKCcvLyBodHRwczovL2dpdGh1Yi5jb20vbmlrbGFzdmgvaHRtbDJjYW52YXNcMDEyIWZ1bmN0aW9uKHQsZSxuKXtmdW5jdGlvbiByKHQsZSxuLHIpe3JldHVybiBjKHQsbixyLGUpLnRoZW4oZnVuY3Rpb24oYSl7RSgiRG9jdW1lbnQgY2xvbmVkIik7dmFyIGM9IlsiK0VlKyI9Jyd0cnVlJyddIjt0LnF1ZXJ5U2VsZWN0b3IoYykucmVtb3ZlQXR0cmlidXRlKEVlKTt2YXIgaD1hLmNvbnRlbnRXaW5kb3csdT1oLmRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYykscD1uZXcgZGUoaC5kb2N1bWVudCksbD1uZXcgbShlLHApLGQ9Qih1KSxmPSJ2aWV3Ij09PWUudHlwZT9NYXRoLm1pbihkLndpZHRoLG4pOm8oKSxnPSJ2aWV3Ij09PWUudHlwZT9NYXRoLm1pbihkLmhlaWdodCxyKTpzKCkseT1uZXcgeGUoZixnLGwsZSksdj1uZXcgUCh1LHkscCxsLGUpO3JldHVybiB2LnJlYWR5LnRoZW4oZnVuY3Rpb24oKXtFKCJGaW5pc2hlZCByZW5kZXJpbmciKTt2YXIgdD0idmlldyI9PT1lLnR5cGV8fHUhPT1oLmRvY3VtZW50LmJvZHkmJnUhPT1oLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudD9pKHkuY2FudmFzLGQpOnkuY2FudmFzO3JldHVybiBlLnJlbW92ZUNvbnRhaW5lciYmKGEucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChhKSxFKCJDbGVhbmVkIHVwIGNvbnRhaW5lciIpKSx0fSl9KX1mdW5jdGlvbiBpKHQsbil7dmFyIHI9ZS5jcmVhdGVFbGVtZW50KCJjYW52YXMiKSxpPU1hdGgubWluKHQud2lkdGgtMSxNYXRoLm1heCgwLG4ubGVmdCkpLG89TWF0aC5taW4odC53aWR0aCxNYXRoLm1heCgxLG4ubGVmdCtuLndpZHRoKSkscz1NYXRoLm1pbih0LmhlaWdodC0xLE1hdGgubWF4KDAsbi50b3ApKSxhPU1hdGgubWluKHQuaGVpZ2h0LE1hdGgubWF4KDEsbi50b3Arbi5oZWlnaHQpKSxjPXIud2lkdGg9by1pLGg9ci5oZWlnaHQ9YS1zO3JldHVybiBFKCJDcm9wcGluZyBjYW52YXMgYXQ6IiwibGVmdDoiLG4ubGVmdCwidG9wOiIsbi50b3AsIndpZHRoOiIsbi53aWR0aCwiaGVpZ2h0OiIsbi5oZWlnaHQpLEUoIlJlc3VsdGluZyBjcm9wIHdpdGggd2lkdGgiLGMsImFuZCBoZWlnaHQiLGgsIiB3aXRoIHgiLGksImFuZCB5IixzKSxyLmdldENvbnRleHQoIjJkIikuZHJhd0ltYWdlKHQsaSxzLGMsaCwwLDAsYyxoKSxyfWZ1bmN0aW9uIG8oKXtyZXR1cm4gTWF0aC5tYXgoTWF0aC5tYXgoZS5ib2R5LnNjcm9sbFdpZHRoLGUuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFdpZHRoKSxNYXRoLm1heChlLmJvZHkub2Zmc2V0V2lkdGgsZS5kb2N1bWVudEVsZW1lbnQub2Zmc2V0V2lkdGgpLE1hdGgubWF4KGUuYm9keS5jbGllbnRXaWR0aCxlLmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCkpfWZ1bmN0aW9uIHMoKXtyZXR1cm4gTWF0aC5tYXgoTWF0aC5tYXgoZS5ib2R5LnNjcm9sbEhlaWdodCxlLmRvY3VtZW50RWxlbWVudC5zY3JvbGxIZWlnaHQpLE1hdGgubWF4KGUuYm9keS5vZmZzZXRIZWlnaHQsZS5kb2N1bWVudEVsZW1lbnQub2Zmc2V0SGVpZ2h0KSxNYXRoLm1heChlLmJvZHkuY2xpZW50SGVpZ2h0LGUuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkpfWZ1bmN0aW9uIGEoKXtyZXR1cm4iZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJQUFBQUFBQVAvLy95SDVCQUVBQUFBQUxBQUFBQUFCQUFFQUFBSUJSQUE3In1mdW5jdGlvbiBjKGUsbixyLGkpe3ZhciBvPWUuZG9jdW1lbnRFbGVtZW50LmNsb25lTm9kZSghMCkscz1lLmNyZWF0ZUVsZW1lbnQoImlmcmFtZSIpO3JldHVybiBzLnN0eWxlLnZpc2liaWxpdHk9ImhpZGRlbiIscy5zdHlsZS5wb3NpdGlvbj0iYWJzb2x1dGUiLHMuc3R5bGUubGVmdD1zLnN0eWxlLnRvcD0iLTEwMDAwcHgiLHMud2lkdGg9bixzLmhlaWdodD1yLHMuc2Nyb2xsaW5nPSJubyIsZS5ib2R5LmFwcGVuZENoaWxkKHMpLG5ldyBQcm9taXNlKGZ1bmN0aW9uKGUpe3ZhciBuPXMuY29udGVudFdpbmRvdy5kb2N1bWVudDtzLmNvbnRlbnRXaW5kb3cub25sb2FkPXMub25sb2FkPWZ1bmN0aW9uKCl7ZShzKX0sbi5vcGVuKCksbi53cml0ZSgiPCFET0NUWVBFIGh0bWw+Iiksbi5jbG9zZSgpLG4ucmVwbGFjZUNoaWxkKGgobi5hZG9wdE5vZGUobykpLG4uZG9jdW1lbnRFbGVtZW50KSwidmlldyI9PT1pLnR5cGUmJnMuY29udGVudFdpbmRvdy5zY3JvbGxUbyh0LnBhZ2VYT2Zmc2V0LHQucGFnZVlPZmZzZXQpfSl9ZnVuY3Rpb24gaCh0KXtyZXR1cm5bXS5zbGljZS5jYWxsKHQuY2hpbGROb2RlcywwKS5maWx0ZXIodSkuZm9yRWFjaChmdW5jdGlvbihlKXsiU0NSSVBUIj09PWUudGFnTmFtZT90LnJlbW92ZUNoaWxkKGUpOmgoZSl9KSx0fWZ1bmN0aW9uIHUodCl7cmV0dXJuIHQubm9kZVR5cGU9PT1Ob2RlLkVMRU1FTlRfTk9ERX1mdW5jdGlvbiBwKHQpe2lmKHRoaXMuc3JjPXQsRSgiRHVtbXlJbWFnZUNvbnRhaW5lciBmb3IiLHQpLCF0aGlzLnByb21pc2V8fCF0aGlzLmltYWdlKXtFKCJJbml0aWF0aW5nIER1bW15SW1hZ2VDb250YWluZXIiKSxwLnByb3RvdHlwZS5pbWFnZT1uZXcgSW1hZ2U7dmFyIGU9dGhpcy5pbWFnZTtwLnByb3RvdHlwZS5wcm9taXNlPW5ldyBQcm9taXNlKGZ1bmN0aW9uKHQsbil7ZS5vbmxvYWQ9dCxlLm9uZXJyb3I9bixlLnNyYz1hKCksZS5jb21wbGV0ZT09PSEwJiZ0KGUpfSl9fWZ1bmN0aW9uIGwodCxuKXt2YXIgcixpLG89ZS5jcmVhdGVFbGVtZW50KCJkaXYiKSxzPWUuY3JlYXRlRWxlbWVudCgiaW1nIiksYz1lLmNyZWF0ZUVsZW1lbnQoInNwYW4iKSxoPSJIaWRkZW4gVGV4dCI7by5zdHlsZS52aXNpYmlsaXR5PSJoaWRkZW4iLG8uc3R5bGUuZm9udEZhbWlseT10LG8uc3R5bGUuZm9udFNpemU9bixvLnN0eWxlLm1hcmdpbj0wLG8uc3R5bGUucGFkZGluZz0wLGUuYm9keS5hcHBlbmRDaGlsZChvKSxzLnNyYz1hKCkscy53aWR0aD0xLHMuaGVpZ2h0PTEscy5zdHlsZS5tYXJnaW49MCxzLnN0eWxlLnBhZGRpbmc9MCxzLnN0eWxlLnZlcnRpY2FsQWxpZ249ImJhc2VsaW5lIixjLnN0eWxlLmZvbnRGYW1pbHk9dCxjLnN0eWxlLmZvbnRTaXplPW4sYy5zdHlsZS5tYXJnaW49MCxjLnN0eWxlLnBhZGRpbmc9MCxjLmFwcGVuZENoaWxkKGUuY3JlYXRlVGV4dE5vZGUoaCkpLG8uYXBwZW5kQ2hpbGQoYyksby5hcHBlbmRDaGlsZChzKSxyPXMub2Zmc2V0VG9wLWMub2Zmc2V0VG9wKzEsby5yZW1vdmVDaGlsZChjKSxvLmFwcGVuZENoaWxkKGUuY3JlYXRlVGV4dE5vZGUoaCkpLG8uc3R5bGUubGluZUhlaWdodD0ibm9ybWFsIixzLnN0eWxlLnZlcnRpY2FsQWxpZ249InN1cGVyIixpPXMub2Zmc2V0VG9wLW8ub2Zmc2V0VG9wKzEsZS5ib2R5LnJlbW92ZUNoaWxkKG8pLHRoaXMuYmFzZWxpbmU9cix0aGlzLmxpbmVXaWR0aD0xLHRoaXMubWlkZGxlPWl9ZnVuY3Rpb24gZCgpe3RoaXMuZGF0YT17fX1mdW5jdGlvbiBmKHQpe3RoaXMuc3JjPXQudmFsdWUsdGhpcy5jb2xvclN0b3BzPVtdLHRoaXMudHlwZT1udWxsLHRoaXMueDA9LjUsdGhpcy55MD0uNSx0aGlzLngxPS41LHRoaXMueTE9LjUsdGhpcy5wcm9taXNlPVByb21pc2UucmVzb2x2ZSghMCl9ZnVuY3Rpb24gZyh0LGUpe3RoaXMuc3JjPXQsdGhpcy5pbWFnZT1uZXcgSW1hZ2U7dmFyIG49dGhpczt0aGlzLnRhaW50ZWQ9bnVsbCx0aGlzLnByb21pc2U9bmV3IFByb21pc2UoZnVuY3Rpb24ocixpKXtuLmltYWdlLm9ubG9hZD1yLG4uaW1hZ2Uub25lcnJvcj1pLGUmJihuLmltYWdlLmNyb3NzT3JpZ2luPSJhbm9ueW1vdXMiKSxuLmltYWdlLnNyYz10LG4uaW1hZ2UuY29tcGxldGU9PT0hMCYmcihuLmltYWdlKX0pWyJjYXRjaCJdKGZ1bmN0aW9uKCl7dmFyIGU9bmV3IHAodCk7cmV0dXJuIGUucHJvbWlzZS50aGVuKGZ1bmN0aW9uKHQpe24uaW1hZ2U9dH0pfSl9ZnVuY3Rpb24gbShlLG4pe3RoaXMubGluaz1udWxsLHRoaXMub3B0aW9ucz1lLHRoaXMuc3VwcG9ydD1uLHRoaXMub3JpZ2luPXQubG9jYXRpb24ucHJvdG9jb2wrdC5sb2NhdGlvbi5ob3N0bmFtZSt0LmxvY2F0aW9uLnBvcnR9ZnVuY3Rpb24geSh0KXtyZXR1cm4iSU1HIj09PXQubm9kZS5ub2RlTmFtZX1mdW5jdGlvbiB2KHQpe3JldHVybiJzdmciPT09dC5ub2RlLm5vZGVOYW1lfWZ1bmN0aW9uIHcodCl7cmV0dXJue2FyZ3M6W3Qubm9kZS5zcmNdLG1ldGhvZDoidXJsIn19ZnVuY3Rpb24gYih0KXtyZXR1cm57YXJnczpbdC5ub2RlXSxtZXRob2Q6InN2ZyJ9fWZ1bmN0aW9uIHgodCl7Zi5hcHBseSh0aGlzLGFyZ3VtZW50cyksdGhpcy50eXBlPXRoaXMuVFlQRVMuTElORUFSO3ZhciBlPW51bGw9PT10LmFyZ3NbMF0ubWF0Y2godGhpcy5zdGVwUmVnRXhwKTtlP3QuYXJnc1swXS5zcGxpdCgiICIpLnJldmVyc2UoKS5mb3JFYWNoKGZ1bmN0aW9uKHQpe3N3aXRjaCh0KXtjYXNlImxlZnQiOnRoaXMueDA9MCx0aGlzLngxPTE7YnJlYWs7Y2FzZSJ0b3AiOnRoaXMueTA9MCx0aGlzLnkxPTE7YnJlYWs7Y2FzZSJyaWdodCI6dGhpcy54MD0xLHRoaXMueDE9MDticmVhaztjYXNlImJvdHRvbSI6dGhpcy55MD0xLHRoaXMueTE9MDticmVhaztjYXNlInRvIjp2YXIgZT10aGlzLnkwLG49dGhpcy54MDt0aGlzLnkwPXRoaXMueTEsdGhpcy54MD10aGlzLngxLHRoaXMueDE9bix0aGlzLnkxPWU7YnJlYWs7ZGVmYXVsdDp2YXIgcj10Lm1hdGNoKHRoaXMuYW5nbGVSZWdFeHApO2lmKHIpc3dpdGNoKHJbMl0pe2Nhc2UiZGVnIjp2YXIgaT1wYXJzZUZsb2F0KHJbMV0pLG89aS8oMTgwL01hdGguUEkpLHM9TWF0aC50YW4obyk7dGhpcy55MD0yL01hdGgudGFuKHMpLzIsdGhpcy54MD0wLHRoaXMueDE9MSx0aGlzLnkxPTB9fX0sdGhpcyk6KHRoaXMueTA9MCx0aGlzLnkxPTEpLHRoaXMuY29sb3JTdG9wcz10LmFyZ3Muc2xpY2UoZT8xOjApLm1hcChmdW5jdGlvbih0KXt2YXIgZT10Lm1hdGNoKHRoaXMuc3RlcFJlZ0V4cCk7cmV0dXJue2NvbG9yOmVbMV0sc3RvcDoiJSI9PT1lWzNdP2VbMl0vMTAwOm51bGx9fSx0aGlzKSxudWxsPT09dGhpcy5jb2xvclN0b3BzWzBdLnN0b3AmJih0aGlzLmNvbG9yU3RvcHNbMF0uc3RvcD0wKSxudWxsPT09dGhpcy5jb2xvclN0b3BzW3RoaXMuY29sb3JTdG9wcy5sZW5ndGgtMV0uc3RvcCYmKHRoaXMuY29sb3JTdG9wc1t0aGlzLmNvbG9yU3RvcHMubGVuZ3RoLTFdLnN0b3A9MSksdGhpcy5jb2xvclN0b3BzLmZvckVhY2goZnVuY3Rpb24odCxlKXtudWxsPT09dC5zdG9wJiZ0aGlzLmNvbG9yU3RvcHMuc2xpY2UoZSkuc29tZShmdW5jdGlvbihuLHIpe3JldHVybiBudWxsIT09bi5zdG9wPyh0LnN0b3A9KG4uc3RvcC10aGlzLmNvbG9yU3RvcHNbZS0xXS5zdG9wKS8ocisxKSt0aGlzLmNvbG9yU3RvcHNbZS0xXS5zdG9wLCEwKTohMX0sdGhpcyl9LHRoaXMpfWZ1bmN0aW9uIEUoKXt0Lmh0bWwyY2FudmFzLmxvZ2dpbmcmJnQuY29uc29sZSYmdC5jb25zb2xlLmxvZyYmRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQuY2FsbCh0LmNvbnNvbGUubG9nLHQuY29uc29sZSkuYXBwbHkodC5jb25zb2xlLFtEYXRlLm5vdygpLXQuaHRtbDJjYW52YXMuc3RhcnQrIm1zIiwiaHRtbDJjYW52YXM6Il0uY29uY2F0KFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLDApKSl9ZnVuY3Rpb24gVCh0LGUpe3RoaXMubm9kZT10LHRoaXMucGFyZW50PWUsdGhpcy5zdGFjaz1udWxsLHRoaXMuYm91bmRzPW51bGwsdGhpcy5vZmZzZXRCb3VuZHM9bnVsbCx0aGlzLnZpc2libGU9bnVsbCx0aGlzLmNvbXB1dGVkU3R5bGVzPW51bGwsdGhpcy5zdHlsZXM9e30sdGhpcy5iYWNrZ3JvdW5kSW1hZ2VzPW51bGwsdGhpcy50cmFuc2Zvcm1EYXRhPW51bGwsdGhpcy50cmFuc2Zvcm1NYXRyaXg9bnVsbH1mdW5jdGlvbiBDKHQpe3ZhciBlPXQub3B0aW9uc1t0LnNlbGVjdGVkSW5kZXh8fDBdO3JldHVybiBlP2UudGV4dHx8IiI6IiJ9ZnVuY3Rpb24gayh0KXtyZXR1cm4gdCYmIm1hdHJpeCI9PT10WzFdP3RbMl0uc3BsaXQoIiwiKS5tYXAoZnVuY3Rpb24odCl7cmV0dXJuIHBhcnNlRmxvYXQodC50cmltKCkpfSk6dm9pZCAwfWZ1bmN0aW9uIEkodCl7cmV0dXJuLTEhPT10LnRvU3RyaW5nKCkuaW5kZXhPZigiJSIpfWZ1bmN0aW9uIFModCl7dmFyIGUsbixyLGksbyxzLGEsYz0iIFxyXG4gICIsaD1bXSx1PTAscD0wLGw9ZnVuY3Rpb24oKXtlJiYoJyciJyc9PT1uLnN1YnN0cigwLDEpJiYobj1uLnN1YnN0cigxLG4ubGVuZ3RoLTIpKSxuJiZhLnB1c2gobiksIi0iPT09ZS5zdWJzdHIoMCwxKSYmKGk9ZS5pbmRleE9mKCItIiwxKSsxKT4wJiYocj1lLnN1YnN0cigwLGkpLGU9ZS5zdWJzdHIoaSkpLGgucHVzaCh7cHJlZml4OnIsbWV0aG9kOmUudG9Mb3dlckNhc2UoKSx2YWx1ZTpvLGFyZ3M6YSxpbWFnZTpudWxsfSkpLGE9W10sZT1yPW49bz0iIn07cmV0dXJuIGE9W10sZT1yPW49bz0iIix0LnNwbGl0KCIiKS5mb3JFYWNoKGZ1bmN0aW9uKHQpe2lmKCEoMD09PXUmJmMuaW5kZXhPZih0KT4tMSkpe3N3aXRjaCh0KXtjYXNlJyciJyc6cz9zPT09dCYmKHM9bnVsbCk6cz10O2JyZWFrO2Nhc2UiKCI6aWYocylicmVhaztpZigwPT09dSlyZXR1cm4gdT0xLHZvaWQobys9dCk7cCsrO2JyZWFrO2Nhc2UiKSI6aWYocylicmVhaztpZigxPT09dSl7aWYoMD09PXApcmV0dXJuIHU9MCxvKz10LHZvaWQgbCgpO3AtLX1icmVhaztjYXNlIiwiOmlmKHMpYnJlYWs7aWYoMD09PXUpcmV0dXJuIHZvaWQgbCgpO2lmKDE9PT11JiYwPT09cCYmIWUubWF0Y2goL151cmwkL2kpKXJldHVybiBhLnB1c2gobiksbj0iIix2b2lkKG8rPXQpfW8rPXQsMD09PXU/ZSs9dDpuKz10fX0pLGwoKSxofWZ1bmN0aW9uIFIodCl7cmV0dXJuIHQucmVwbGFjZSgicHgiLCIiKX1mdW5jdGlvbiBPKHQpe3JldHVybiBwYXJzZUZsb2F0KHQpfWZ1bmN0aW9uIEIodCl7aWYodC5nZXRCb3VuZGluZ0NsaWVudFJlY3Qpe3ZhciBlPXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksbj0iQk9EWSI9PT10Lm5vZGVOYW1lLHI9bj90LnNjcm9sbFdpZHRoOm51bGw9PXQub2Zmc2V0V2lkdGg/ZS53aWR0aDp0Lm9mZnNldFdpZHRoO3JldHVybnt0b3A6ZS50b3AsYm90dG9tOmUuYm90dG9tfHxlLnRvcCtlLmhlaWdodCxyaWdodDplLmxlZnQrcixsZWZ0OmUubGVmdCx3aWR0aDpyLGhlaWdodDpuP3Quc2Nyb2xsSGVpZ2h0Om51bGw9PXQub2Zmc2V0SGVpZ2h0P2UuaGVpZ2h0OnQub2Zmc2V0SGVpZ2h0fX1yZXR1cm57fX1mdW5jdGlvbiBNKHQpe3ZhciBlPXQub2Zmc2V0UGFyZW50P00odC5vZmZzZXRQYXJlbnQpOnt0b3A6MCxsZWZ0OjB9O3JldHVybnt0b3A6dC5vZmZzZXRUb3ArZS50b3AsYm90dG9tOnQub2Zmc2V0VG9wK3Qub2Zmc2V0SGVpZ2h0K2UudG9wLHJpZ2h0OnQub2Zmc2V0TGVmdCtlLmxlZnQrdC5vZmZzZXRXaWR0aCxsZWZ0OnQub2Zmc2V0TGVmdCtlLmxlZnQsd2lkdGg6dC5vZmZzZXRXaWR0aCxoZWlnaHQ6dC5vZmZzZXRIZWlnaHR9fWZ1bmN0aW9uIFAodCxlLG4scixpKXtFKCJTdGFydGluZyBOb2RlUGFyc2VyIiksdGhpcy5yZW5kZXJlcj1lLHRoaXMub3B0aW9ucz1pLHRoaXMucmFuZ2U9bnVsbCx0aGlzLnN1cHBvcnQ9bix0aGlzLnJlbmRlclF1ZXVlPVtdLHRoaXMuc3RhY2s9bmV3IGxlKCEwLDEsdC5vd25lckRvY3VtZW50LG51bGwpO3ZhciBvPW5ldyBUKHQsbnVsbCk7dCE9PXQub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQmJnRoaXMucmVuZGVyZXIuaXNUcmFuc3BhcmVudChvLmNzcygiYmFja2dyb3VuZENvbG9yIikpJiZlLnJlY3RhbmdsZSgwLDAsZS53aWR0aCxlLmhlaWdodCxuZXcgVCh0Lm93bmVyRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LG51bGwpLmNzcygiYmFja2dyb3VuZENvbG9yIikpLG8udmlzaWJpbGU9by5pc0VsZW1lbnRWaXNpYmxlKCksdGhpcy5jcmVhdGVQc2V1ZG9IaWRlU3R5bGVzKHQub3duZXJEb2N1bWVudCksdGhpcy5ub2Rlcz1jZShbb10uY29uY2F0KHRoaXMuZ2V0Q2hpbGRyZW4obykpLmZpbHRlcihmdW5jdGlvbih0KXtyZXR1cm4gdC52aXNpYmxlPXQuaXNFbGVtZW50VmlzaWJsZSgpfSkubWFwKHRoaXMuZ2V0UHNldWRvRWxlbWVudHMsdGhpcykpLHRoaXMuZm9udE1ldHJpY3M9bmV3IGQsRSgiRmV0Y2hlZCBub2RlcyIpLHRoaXMuaW1hZ2VzPXIuZmV0Y2godGhpcy5ub2Rlcy5maWx0ZXIodGUpKSxFKCJDcmVhdGluZyBzdGFja2luZyBjb250ZXh0cyIpLHRoaXMuY3JlYXRlU3RhY2tpbmdDb250ZXh0cygpLEUoIlNvcnRpbmcgc3RhY2tpbmcgY29udGV4dHMiKSx0aGlzLnNvcnRTdGFja2luZ0NvbnRleHRzKHRoaXMuc3RhY2spLHRoaXMucmVhZHk9dGhpcy5pbWFnZXMucmVhZHkudGhlbihpZShmdW5jdGlvbigpe3JldHVybiBFKCJJbWFnZXMgbG9hZGVkLCBzdGFydGluZyBwYXJzaW5nIiksdGhpcy5wYXJzZSh0aGlzLnN0YWNrKSxFKCJSZW5kZXIgcXVldWUgY3JlYXRlZCB3aXRoICIrdGhpcy5yZW5kZXJRdWV1ZS5sZW5ndGgrIiBpdGVtcyIpLG5ldyBQcm9taXNlKGllKGZ1bmN0aW9uKHQpe2kuYXN5bmM/ImZ1bmN0aW9uIj09dHlwZW9mIGkuYXN5bmM/aS5hc3luYy5jYWxsKHRoaXMsdGhpcy5yZW5kZXJRdWV1ZSx0KToodGhpcy5yZW5kZXJJbmRleD0wLHRoaXMuYXN5bmNSZW5kZXJlcih0aGlzLnJlbmRlclF1ZXVlLHQpKToodGhpcy5yZW5kZXJRdWV1ZS5mb3JFYWNoKHRoaXMucGFpbnQsdGhpcyksdCgpKX0sdGhpcykpfSx0aGlzKSl9ZnVuY3Rpb24gQSh0KXtyZXR1cm4gdC5yZXBsYWNlKC8oXC1bYS16XSkvZyxmdW5jdGlvbih0KXtyZXR1cm4gdC50b1VwcGVyQ2FzZSgpLnJlcGxhY2UoIi0iLCIiKX0pfWZ1bmN0aW9uIE4oKXt9ZnVuY3Rpb24gTCh0LGUsbixyKXt2YXIgaT00KigoTWF0aC5zcXJ0KDIpLTEpLzMpLG89bippLHM9cippLGE9dCtuLGM9ZStyO3JldHVybnt0b3BMZWZ0Ol8oe3g6dCx5OmN9LHt4OnQseTpjLXN9LHt4OmEtbyx5OmV9LHt4OmEseTplfSksdG9wUmlnaHQ6Xyh7eDp0LHk6ZX0se3g6dCtvLHk6ZX0se3g6YSx5OmMtc30se3g6YSx5OmN9KSxib3R0b21SaWdodDpfKHt4OmEseTplfSx7eDphLHk6ZStzfSx7eDp0K28seTpjfSx7eDp0LHk6Y30pLGJvdHRvbUxlZnQ6Xyh7eDphLHk6Y30se3g6YS1vLHk6Y30se3g6dCx5OmUrc30se3g6dCx5OmV9KX19ZnVuY3Rpb24gRCh0LGUsbil7dmFyIHI9dC5sZWZ0LGk9dC50b3Asbz10LndpZHRoLHM9dC5oZWlnaHQsYT1lWzBdWzBdLGM9ZVswXVsxXSxoPWVbMV1bMF0sdT1lWzFdWzFdLHA9ZVsyXVswXSxsPWVbMl1bMV0sZD1lWzNdWzBdLGY9ZVszXVsxXSxnPW8taCxtPXMtbCx5PW8tcCx2PXMtZjtyZXR1cm57dG9wTGVmdE91dGVyOkwocixpLGEsYykudG9wTGVmdC5zdWJkaXZpZGUoLjUpLHRvcExlZnRJbm5lcjpMKHIrblszXS53aWR0aCxpK25bMF0ud2lkdGgsTWF0aC5tYXgoMCxhLW5bM10ud2lkdGgpLE1hdGgubWF4KDAsYy1uWzBdLndpZHRoKSkudG9wTGVmdC5zdWJkaXZpZGUoLjUpLHRvcFJpZ2h0T3V0ZXI6TChyK2csaSxoLHUpLnRvcFJpZ2h0LnN1YmRpdmlkZSguNSksdG9wUmlnaHRJbm5lcjpMKHIrTWF0aC5taW4oZyxvK25bM10ud2lkdGgpLGkrblswXS53aWR0aCxnPm8rblszXS53aWR0aD8wOmgtblszXS53aWR0aCx1LW5bMF0ud2lkdGgpLnRvcFJpZ2h0LnN1YmRpdmlkZSguNSksYm90dG9tUmlnaHRPdXRlcjpMKHIreSxpK20scCxsKS5ib3R0b21SaWdodC5zdWJkaXZpZGUoLjUpLGJvdHRvbVJpZ2h0SW5uZXI6TChyK01hdGgubWluKHksbytuWzNdLndpZHRoKSxpK01hdGgubWluKG0scytuWzBdLndpZHRoKSxNYXRoLm1heCgwLHAtblsxXS53aWR0aCksTWF0aC5tYXgoMCxsLW5bMl0ud2lkdGgpKS5ib3R0b21SaWdodC5zdWJkaXZpZGUoLjUpLGJvdHRvbUxlZnRPdXRlcjpMKHIsaSt2LGQsZikuYm90dG9tTGVmdC5zdWJkaXZpZGUoLjUpLGJvdHRvbUxlZnRJbm5lcjpMKHIrblszXS53aWR0aCxpK3YsTWF0aC5tYXgoMCxkLW5bM10ud2lkdGgpLE1hdGgubWF4KDAsZi1uWzJdLndpZHRoKSkuYm90dG9tTGVmdC5zdWJkaXZpZGUoLjUpfX1mdW5jdGlvbiBfKHQsZSxuLHIpe3ZhciBpPWZ1bmN0aW9uKHQsZSxuKXtyZXR1cm57eDp0LngrKGUueC10LngpKm4seTp0LnkrKGUueS10LnkpKm59fTtyZXR1cm57c3RhcnQ6dCxzdGFydENvbnRyb2w6ZSxlbmRDb250cm9sOm4sZW5kOnIsc3ViZGl2aWRlOmZ1bmN0aW9uKG8pe3ZhciBzPWkodCxlLG8pLGE9aShlLG4sbyksYz1pKG4scixvKSxoPWkocyxhLG8pLHU9aShhLGMsbykscD1pKGgsdSxvKTtyZXR1cm5bXyh0LHMsaCxwKSxfKHAsdSxjLHIpXX0sY3VydmVUbzpmdW5jdGlvbih0KXt0LnB1c2goWyJiZXppZXJDdXJ2ZSIsZS54LGUueSxuLngsbi55LHIueCxyLnldKX0sY3VydmVUb1JldmVyc2VkOmZ1bmN0aW9uKHIpe3IucHVzaChbImJlemllckN1cnZlIixuLngsbi55LGUueCxlLnksdC54LHQueV0pfX19ZnVuY3Rpb24gRih0LGUsbixyLGksbyxzKXt2YXIgYT1bXTtyZXR1cm4gZVswXT4wfHxlWzFdPjA/KGEucHVzaChbImxpbmUiLHJbMV0uc3RhcnQueCxyWzFdLnN0YXJ0LnldKSxyWzFdLmN1cnZlVG8oYSkpOmEucHVzaChbImxpbmUiLHQuYzFbMF0sdC5jMVsxXV0pLG5bMF0+MHx8blsxXT4wPyhhLnB1c2goWyJsaW5lIixvWzBdLnN0YXJ0Lngsb1swXS5zdGFydC55XSksb1swXS5jdXJ2ZVRvKGEpLGEucHVzaChbImxpbmUiLHNbMF0uZW5kLngsc1swXS5lbmQueV0pLHNbMF0uY3VydmVUb1JldmVyc2VkKGEpKTooYS5wdXNoKFsibGluZSIsdC5jMlswXSx0LmMyWzFdXSksYS5wdXNoKFsibGluZSIsdC5jM1swXSx0LmMzWzFdXSkpLGVbMF0+MHx8ZVsxXT4wPyhhLnB1c2goWyJsaW5lIixpWzFdLmVuZC54LGlbMV0uZW5kLnldKSxpWzFdLmN1cnZlVG9SZXZlcnNlZChhKSk6YS5wdXNoKFsibGluZSIsdC5jNFswXSx0LmM0WzFdXSksYX1mdW5jdGlvbiBXKHQsZSxuLHIsaSxvLHMpe2VbMF0+MHx8ZVsxXT4wPyh0LnB1c2goWyJsaW5lIixyWzBdLnN0YXJ0LngsclswXS5zdGFydC55XSksclswXS5jdXJ2ZVRvKHQpLHJbMV0uY3VydmVUbyh0KSk6dC5wdXNoKFsibGluZSIsbyxzXSksKG5bMF0+MHx8blsxXT4wKSYmdC5wdXNoKFsibGluZSIsaVswXS5zdGFydC54LGlbMF0uc3RhcnQueV0pfWZ1bmN0aW9uIEgodCl7cmV0dXJuIHQuY3NzSW50KCJ6SW5kZXgiKTwwfWZ1bmN0aW9uIGoodCl7cmV0dXJuIHQuY3NzSW50KCJ6SW5kZXgiKT4wfWZ1bmN0aW9uIFYodCl7cmV0dXJuIDA9PT10LmNzc0ludCgiekluZGV4Iil9ZnVuY3Rpb24geih0KXtyZXR1cm4tMSE9PVsiaW5saW5lIiwiaW5saW5lLWJsb2NrIiwiaW5saW5lLXRhYmxlIl0uaW5kZXhPZih0LmNzcygiZGlzcGxheSIpKX1mdW5jdGlvbiBZKHQpe3JldHVybiB0IGluc3RhbmNlb2YgbGV9ZnVuY3Rpb24gWCh0KXtyZXR1cm4gdC5ub2RlLmRhdGEudHJpbSgpLmxlbmd0aD4wfWZ1bmN0aW9uIEcodCl7cmV0dXJuL14obm9ybWFsfG5vbmV8MHB4KSQvLnRlc3QodC5wYXJlbnQuY3NzKCJsZXR0ZXJTcGFjaW5nIikpfWZ1bmN0aW9uIFUodCl7cmV0dXJuWyJUb3BMZWZ0IiwiVG9wUmlnaHQiLCJCb3R0b21SaWdodCIsIkJvdHRvbUxlZnQiXS5tYXAoZnVuY3Rpb24oZSl7dmFyIG49dC5jc3MoImJvcmRlciIrZSsiUmFkaXVzIikscj1uLnNwbGl0KCIgIik7cmV0dXJuIHIubGVuZ3RoPD0xJiYoclsxXT1yWzBdKSxyLm1hcChvZSl9KX1mdW5jdGlvbiBRKHQpe3JldHVybiB0Lm5vZGVUeXBlPT09Tm9kZS5URVhUX05PREV8fHQubm9kZVR5cGU9PT1Ob2RlLkVMRU1FTlRfTk9ERX1mdW5jdGlvbiBxKHQpe3ZhciBlPXQuY3NzKCJwb3NpdGlvbiIpLG49ImFic29sdXRlIj09PWV8fCJyZWxhdGl2ZSI9PT1lP3QuY3NzKCJ6SW5kZXgiKToiYXV0byI7cmV0dXJuImF1dG8iIT09bn1mdW5jdGlvbiAkKHQpe3JldHVybiJzdGF0aWMiIT09dC5jc3MoInBvc2l0aW9uIil9ZnVuY3Rpb24gSih0KXtyZXR1cm4ibm9uZSIhPT10LmNzcygiZmxvYXQiKX1mdW5jdGlvbiBLKHQpe3JldHVybi0xIT09WyJpbmxpbmUtYmxvY2siLCJpbmxpbmUtdGFibGUiXS5pbmRleE9mKHQuY3NzKCJkaXNwbGF5IikpfWZ1bmN0aW9uIFoodCl7dmFyIGU9dGhpcztyZXR1cm4gZnVuY3Rpb24oKXtyZXR1cm4hdC5hcHBseShlLGFyZ3VtZW50cyl9fWZ1bmN0aW9uIHRlKHQpe3JldHVybiB0Lm5vZGUubm9kZVR5cGU9PT1Ob2RlLkVMRU1FTlRfTk9ERX1mdW5jdGlvbiBlZSh0KXtyZXR1cm4gdC5ub2RlLm5vZGVUeXBlPT09Tm9kZS5URVhUX05PREV9ZnVuY3Rpb24gbmUodCxlKXtyZXR1cm4gdC5jc3NJbnQoInpJbmRleCIpLWUuY3NzSW50KCJ6SW5kZXgiKX1mdW5jdGlvbiByZSh0KXtyZXR1cm4gdC5jc3MoIm9wYWNpdHkiKTwxfWZ1bmN0aW9uIGllKHQsZSl7cmV0dXJuIGZ1bmN0aW9uKCl7cmV0dXJuIHQuYXBwbHkoZSxhcmd1bWVudHMpfX1mdW5jdGlvbiBvZSh0KXtyZXR1cm4gcGFyc2VJbnQodCwxMCl9ZnVuY3Rpb24gc2UodCl7cmV0dXJuIHQud2lkdGh9ZnVuY3Rpb24gYWUodCl7cmV0dXJuIHQubm9kZS5ub2RlVHlwZSE9PU5vZGUuRUxFTUVOVF9OT0RFfHwtMT09PVsiU0NSSVBUIiwiSEVBRCIsIlRJVExFIiwiT0JKRUNUIiwiQlIiLCJPUFRJT04iXS5pbmRleE9mKHQubm9kZS5ub2RlTmFtZSl9ZnVuY3Rpb24gY2UodCl7cmV0dXJuW10uY29uY2F0LmFwcGx5KFtdLHQpfWZ1bmN0aW9uIGhlKHQpe3ZhciBlPXQuc3Vic3RyKDAsMSk7cmV0dXJuIGU9PT10LnN1YnN0cih0Lmxlbmd0aC0xKSYmZS5tYXRjaCgvJyd8Ii8pP3Quc3Vic3RyKDEsdC5sZW5ndGgtMik6dH1mdW5jdGlvbiB1ZShyLGkpe3ZhciBvPSJodG1sMmNhbnZhc18iK1RlKysscz1lLmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpLGE9ZS5jcmVhdGVFbGVtZW50KCJhIik7YS5ocmVmPXIscj1hLmhyZWY7dmFyIGM9aSsoaS5pbmRleE9mKCI/Iik+LTE/IiYiOiI/IikrInVybD0iK2VuY29kZVVSSUNvbXBvbmVudChyKSsiJmNhbGxiYWNrPSIrbzt0aGlzLnNyYz1yLHRoaXMuaW1hZ2U9bmV3IEltYWdlO3ZhciBoPXRoaXM7dGhpcy5wcm9taXNlPW5ldyBQcm9taXNlKGZ1bmN0aW9uKHIsaSl7aC5pbWFnZS5vbmxvYWQ9cixoLmltYWdlLm9uZXJyb3I9aSx0W29dPWZ1bmN0aW9uKGUpeyJlcnJvcjoiPT09ZS5zdWJzdHJpbmcoMCw2KT9pKCk6aC5pbWFnZS5zcmM9ZSx0W29dPW47dHJ5e2RlbGV0ZSB0W29dfWNhdGNoKHIpe31zLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocyl9LHMuc2V0QXR0cmlidXRlKCJ0eXBlIiwidGV4dC9qYXZhc2NyaXB0Iikscy5zZXRBdHRyaWJ1dGUoInNyYyIsYyksZS5ib2R5LmFwcGVuZENoaWxkKHMpfSlbImNhdGNoIl0oZnVuY3Rpb24oKXt2YXIgdD1uZXcgcChyKTtyZXR1cm4gdC5wcm9taXNlLnRoZW4oZnVuY3Rpb24odCl7aC5pbWFnZT10fSl9KX1mdW5jdGlvbiBwZSh0LGUsbixyKXt0aGlzLndpZHRoPXQsdGhpcy5oZWlnaHQ9ZSx0aGlzLmltYWdlcz1uLHRoaXMub3B0aW9ucz1yfWZ1bmN0aW9uIGxlKHQsZSxuLHIpe1QuY2FsbCh0aGlzLG4sciksdGhpcy5vd25TdGFja2luZz10LHRoaXMuY29udGV4dHM9W10sdGhpcy5jaGlsZHJlbj1bXSx0aGlzLm9wYWNpdHk9KHRoaXMucGFyZW50P3RoaXMucGFyZW50LnN0YWNrLm9wYWNpdHk6MSkqZX1mdW5jdGlvbiBkZSh0KXt0aGlzLnJhbmdlQm91bmRzPXRoaXMudGVzdFJhbmdlQm91bmRzKHQpLHRoaXMuY29ycz10aGlzLnRlc3RDT1JTKCksdGhpcy5zdmc9dGhpcy50ZXN0U1ZHKCl9ZnVuY3Rpb24gZmUodCl7dGhpcy5zcmM9dCx0aGlzLmltYWdlPW51bGw7dmFyIGU9dGhpczt0aGlzLnByb21pc2U9dGhpcy5oYXNGYWJyaWMoKS50aGVuKGZ1bmN0aW9uKCl7cmV0dXJuIGUuaXNJbmxpbmUodCk/UHJvbWlzZS5yZXNvbHZlKGUuaW5saW5lRm9ybWF0dGluZyh0KSk6YmUodCl9KS50aGVuKGZ1bmN0aW9uKHQpe3JldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihuKXtodG1sMmNhbnZhcy5mYWJyaWMubG9hZFNWR0Zyb21TdHJpbmcodCxlLmNyZWF0ZUNhbnZhcy5jYWxsKGUsbikpfSl9KX1mdW5jdGlvbiBnZSh0KXt2YXIgZSxuLHIsaSxvLHMsYSxjLGg9IkFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5Ky8iLHU9dC5sZW5ndGgscD0iIjtmb3IoZT0wO3U+ZTtlKz00KW49aC5pbmRleE9mKHRbZV0pLHI9aC5pbmRleE9mKHRbZSsxXSksaT1oLmluZGV4T2YodFtlKzJdKSxvPWguaW5kZXhPZih0W2UrM10pLHM9bjw8MnxyPj40LGE9KDE1JnIpPDw0fGk+PjIsYz0oMyZpKTw8NnxvLHArPTY0PT09aT9TdHJpbmcuZnJvbUNoYXJDb2RlKHMpOjY0PT09b3x8LTE9PT1vP1N0cmluZy5mcm9tQ2hhckNvZGUocyxhKTpTdHJpbmcuZnJvbUNoYXJDb2RlKHMsYSxjKTtyZXR1cm4gcH1mdW5jdGlvbiBtZSh0KXt0aGlzLnNyYz10LHRoaXMuaW1hZ2U9bnVsbDt2YXIgZT10aGlzO3RoaXMucHJvbWlzZT10aGlzLmhhc0ZhYnJpYygpLnRoZW4oZnVuY3Rpb24oKXtyZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24obil7aHRtbDJjYW52YXMuZmFicmljLnBhcnNlU1ZHRG9jdW1lbnQodCxlLmNyZWF0ZUNhbnZhcy5jYWxsKGUsbikpfSl9KX1mdW5jdGlvbiB5ZSh0LGUpe1QuY2FsbCh0aGlzLHQsZSl9ZnVuY3Rpb24gdmUodCxlLG4pe3JldHVybiB0Lmxlbmd0aD4wP2Urbi50b1VwcGVyQ2FzZSgpOnZvaWQgMH1mdW5jdGlvbiB3ZSh0KXtmLmFwcGx5KHRoaXMsYXJndW1lbnRzKSx0aGlzLnR5cGU9ImxpbmVhciI9PT10LmFyZ3NbMF0/dGhpcy5UWVBFUy5MSU5FQVI6dGhpcy5UWVBFUy5SQURJQUx9ZnVuY3Rpb24gYmUodCl7cmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKGUsbil7dmFyIHI9bmV3IFhNTEh0dHBSZXF1ZXN0O3Iub3BlbigiR0VUIix0KSxyLm9ubG9hZD1mdW5jdGlvbigpezIwMD09PXIuc3RhdHVzP2Uoci5yZXNwb25zZVRleHQpOm4obmV3IEVycm9yKHIuc3RhdHVzVGV4dCkpfSxyLm9uZXJyb3I9ZnVuY3Rpb24oKXtuKG5ldyBFcnJvcigiTmV0d29yayBFcnJvciIpKX0sci5zZW5kKCl9KX1mdW5jdGlvbiB4ZSh0LG4pe3BlLmFwcGx5KHRoaXMsYXJndW1lbnRzKSx0aGlzLmNhbnZhcz1lLmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpLHRoaXMuY2FudmFzLndpZHRoPXQsdGhpcy5jYW52YXMuaGVpZ2h0PW4sdGhpcy5jdHg9dGhpcy5jYW52YXMuZ2V0Q29udGV4dCgiMmQiKSx0aGlzLnRhaW50Q3R4PWUuY3JlYXRlRWxlbWVudCgiY2FudmFzIikuZ2V0Q29udGV4dCgiMmQiKSx0aGlzLmN0eC50ZXh0QmFzZWxpbmU9ImJvdHRvbSIsdGhpcy52YXJpYWJsZXM9e30sRSgiSW5pdGlhbGl6ZWQgQ2FudmFzUmVuZGVyZXIiKX1pZighZnVuY3Rpb24oKXt2YXIgbixyLGksbzshZnVuY3Rpb24oKXt2YXIgdD17fSxlPXt9O249ZnVuY3Rpb24oZSxuLHIpe3RbZV09e2RlcHM6bixjYWxsYmFjazpyfX0sbz1pPXI9ZnVuY3Rpb24obil7ZnVuY3Rpb24gaSh0KXtpZigiLiIhPT10LmNoYXJBdCgwKSlyZXR1cm4gdDtmb3IodmFyIGU9dC5zcGxpdCgiLyIpLHI9bi5zcGxpdCgiLyIpLnNsaWNlKDAsLTEpLGk9MCxvPWUubGVuZ3RoO28+aTtpKyspe3ZhciBzPWVbaV07aWYoIi4uIj09PXMpci5wb3AoKTtlbHNle2lmKCIuIj09PXMpY29udGludWU7ci5wdXNoKHMpfX1yZXR1cm4gci5qb2luKCIvIil9aWYoby5fZWFrX3NlZW49dCxlW25dKXJldHVybiBlW25dO2lmKGVbbl09e30sIXRbbl0pdGhyb3cgbmV3IEVycm9yKCJDb3VsZCBub3QgZmluZCBtb2R1bGUgIituKTtmb3IodmFyIHMsYT10W25dLGM9YS5kZXBzLGg9YS5jYWxsYmFjayx1PVtdLHA9MCxsPWMubGVuZ3RoO2w+cDtwKyspdS5wdXNoKCJleHBvcnRzIj09PWNbcF0/cz17fTpyKGkoY1twXSkpKTt2YXIgZD1oLmFwcGx5KHRoaXMsdSk7cmV0dXJuIGVbbl09c3x8ZH19KCksbigicHJvbWlzZS9hbGwiLFsiLi91dGlscyIsImV4cG9ydHMiXSxmdW5jdGlvbih0LGUpeyJ1c2Ugc3RyaWN0IjtmdW5jdGlvbiBuKHQpe3ZhciBlPXRoaXM7aWYoIXIodCkpdGhyb3cgbmV3IFR5cGVFcnJvcigiWW91IG11c3QgcGFzcyBhbiBhcnJheSB0byBhbGwuIik7cmV0dXJuIG5ldyBlKGZ1bmN0aW9uKGUsbil7ZnVuY3Rpb24gcih0KXtyZXR1cm4gZnVuY3Rpb24oZSl7byh0LGUpfX1mdW5jdGlvbiBvKHQsbil7YVt0XT1uLDA9PT0tLWMmJmUoYSl9dmFyIHMsYT1bXSxjPXQubGVuZ3RoOzA9PT1jJiZlKFtdKTtmb3IodmFyIGg9MDtoPHQubGVuZ3RoO2grKylzPXRbaF0scyYmaShzLnRoZW4pP3MudGhlbihyKGgpLG4pOm8oaCxzKX0pfXZhciByPXQuaXNBcnJheSxpPXQuaXNGdW5jdGlvbjtlLmFsbD1ufSksbigicHJvbWlzZS9hc2FwIixbImV4cG9ydHMiXSxmdW5jdGlvbihuKXsidXNlIHN0cmljdCI7ZnVuY3Rpb24gcigpe3JldHVybiBmdW5jdGlvbigpe3Byb2Nlc3MubmV4dFRpY2socyl9fWZ1bmN0aW9uIGkoKXt2YXIgdD0wLG49bmV3IHUocykscj1lLmNyZWF0ZVRleHROb2RlKCIiKTtyZXR1cm4gbi5vYnNlcnZlKHIse2NoYXJhY3RlckRhdGE6ITB9KSxmdW5jdGlvbigpe3IuZGF0YT10PSsrdCUyfX1mdW5jdGlvbiBvKCl7cmV0dXJuIGZ1bmN0aW9uKCl7cC5zZXRUaW1lb3V0KHMsMSl9fWZ1bmN0aW9uIHMoKXtmb3IodmFyIHQ9MDt0PGwubGVuZ3RoO3QrKyl7dmFyIGU9bFt0XSxuPWVbMF0scj1lWzFdO24ocil9bD1bXX1mdW5jdGlvbiBhKHQsZSl7dmFyIG49bC5wdXNoKFt0LGVdKTsxPT09biYmYygpfXZhciBjLGg9InVuZGVmaW5lZCIhPXR5cGVvZiB0P3Q6e30sdT1oLk11dGF0aW9uT2JzZXJ2ZXJ8fGguV2ViS2l0TXV0YXRpb25PYnNlcnZlcixwPSJ1bmRlZmluZWQiIT10eXBlb2YgZ2xvYmFsP2dsb2JhbDp0aGlzLGw9W107Yz0idW5kZWZpbmVkIiE9dHlwZW9mIHByb2Nlc3MmJiJbb2JqZWN0IHByb2Nlc3NdIj09PXt9LnRvU3RyaW5nLmNhbGwocHJvY2Vzcyk/cigpOnU/aSgpOm8oKSxuLmFzYXA9YX0pLG4oInByb21pc2UvY2FzdCIsWyJleHBvcnRzIl0sZnVuY3Rpb24odCl7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIGUodCl7aWYodCYmIm9iamVjdCI9PXR5cGVvZiB0JiZ0LmNvbnN0cnVjdG9yPT09dGhpcylyZXR1cm4gdDt2YXIgZT10aGlzO3JldHVybiBuZXcgZShmdW5jdGlvbihlKXtlKHQpfSl9dC5jYXN0PWV9KSxuKCJwcm9taXNlL2NvbmZpZyIsWyJleHBvcnRzIl0sZnVuY3Rpb24odCl7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIGUodCxlKXtyZXR1cm4gMiE9PWFyZ3VtZW50cy5sZW5ndGg/blt0XTp2b2lkKG5bdF09ZSl9dmFyIG49e2luc3RydW1lbnQ6ITF9O3QuY29uZmlnPW4sdC5jb25maWd1cmU9ZX0pLG4oInByb21pc2UvcG9seWZpbGwiLFsiLi9wcm9taXNlIiwiLi91dGlscyIsImV4cG9ydHMiXSxmdW5jdGlvbihlLG4scil7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIGkoKXt2YXIgZT0iUHJvbWlzZSJpbiB0JiYiY2FzdCJpbiB0LlByb21pc2UmJiJyZXNvbHZlImluIHQuUHJvbWlzZSYmInJlamVjdCJpbiB0LlByb21pc2UmJiJhbGwiaW4gdC5Qcm9taXNlJiYicmFjZSJpbiB0LlByb21pc2UmJmZ1bmN0aW9uKCl7dmFyIGU7cmV0dXJuIG5ldyB0LlByb21pc2UoZnVuY3Rpb24odCl7ZT10fSkscyhlKX0oKTtlfHwodC5Qcm9taXNlPW8pfXZhciBvPWUuUHJvbWlzZSxzPW4uaXNGdW5jdGlvbjtyLnBvbHlmaWxsPWl9KSxuKCJwcm9taXNlL3Byb21pc2UiLFsiLi9jb25maWciLCIuL3V0aWxzIiwiLi9jYXN0IiwiLi9hbGwiLCIuL3JhY2UiLCIuL3Jlc29sdmUiLCIuL3JlamVjdCIsIi4vYXNhcCIsImV4cG9ydHMiXSxmdW5jdGlvbih0LGUsbixyLGksbyxzLGEsYyl7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIGgodCl7aWYoIUUodCkpdGhyb3cgbmV3IFR5cGVFcnJvcigiWW91IG11c3QgcGFzcyBhIHJlc29sdmVyIGZ1bmN0aW9uIGFzIHRoZSBmaXJzdCBhcmd1bWVudCB0byB0aGUgcHJvbWlzZSBjb25zdHJ1Y3RvciIpO2lmKCEodGhpcyBpbnN0YW5jZW9mIGgpKXRocm93IG5ldyBUeXBlRXJyb3IoIkZhaWxlZCB0byBjb25zdHJ1Y3QgJydQcm9taXNlJyc6IFBsZWFzZSB1c2UgdGhlICcnbmV3Jycgb3BlcmF0b3IsIHRoaXMgb2JqZWN0IGNvbnN0cnVjdG9yIGNhbm5vdCBiZSBjYWxsZWQgYXMgYSBmdW5jdGlvbi4iKTt0aGlzLl9zdWJzY3JpYmVycz1bXSx1KHQsdGhpcyl9ZnVuY3Rpb24gdSh0LGUpe2Z1bmN0aW9uIG4odCl7ZyhlLHQpfWZ1bmN0aW9uIHIodCl7eShlLHQpfXRyeXt0KG4scil9Y2F0Y2goaSl7cihpKX19ZnVuY3Rpb24gcCh0LGUsbixyKXt2YXIgaSxvLHMsYSxjPUUobik7aWYoYyl0cnl7aT1uKHIpLHM9ITB9Y2F0Y2goaCl7YT0hMCxvPWh9ZWxzZSBpPXIscz0hMDtmKGUsaSl8fChjJiZzP2coZSxpKTphP3koZSxvKTp0PT09TT9nKGUsaSk6dD09PVAmJnkoZSxpKSl9ZnVuY3Rpb24gbCh0LGUsbixyKXt2YXIgaT10Ll9zdWJzY3JpYmVycyxvPWkubGVuZ3RoO2lbb109ZSxpW28rTV09bixpW28rUF09cn1mdW5jdGlvbiBkKHQsZSl7Zm9yKHZhciBuLHIsaT10Ll9zdWJzY3JpYmVycyxvPXQuX2RldGFpbCxzPTA7czxpLmxlbmd0aDtzKz0zKW49aVtzXSxyPWlbcytlXSxwKGUsbixyLG8pO3QuX3N1YnNjcmliZXJzPW51bGx9ZnVuY3Rpb24gZih0LGUpe3ZhciBuLHI9bnVsbDt0cnl7aWYodD09PWUpdGhyb3cgbmV3IFR5cGVFcnJvcigiQSBwcm9taXNlcyBjYWxsYmFjayBjYW5ub3QgcmV0dXJuIHRoYXQgc2FtZSBwcm9taXNlLiIpO2lmKHgoZSkmJihyPWUudGhlbixFKHIpKSlyZXR1cm4gci5jYWxsKGUsZnVuY3Rpb24ocil7cmV0dXJuIG4/ITA6KG49ITAsdm9pZChlIT09cj9nKHQscik6bSh0LHIpKSl9LGZ1bmN0aW9uKGUpe3JldHVybiBuPyEwOihuPSEwLHZvaWQgeSh0LGUpKX0pLCEwfWNhdGNoKGkpe3JldHVybiBuPyEwOih5KHQsaSksITApfXJldHVybiExfWZ1bmN0aW9uIGcodCxlKXt0PT09ZT9tKHQsZSk6Zih0LGUpfHxtKHQsZSl9ZnVuY3Rpb24gbSh0LGUpe3QuX3N0YXRlPT09TyYmKHQuX3N0YXRlPUIsdC5fZGV0YWlsPWUsYi5hc3luYyh2LHQpKX1mdW5jdGlvbiB5KHQsZSl7dC5fc3RhdGU9PT1PJiYodC5fc3RhdGU9Qix0Ll9kZXRhaWw9ZSxiLmFzeW5jKHcsdCkpfWZ1bmN0aW9uIHYodCl7ZCh0LHQuX3N0YXRlPU0pfWZ1bmN0aW9uIHcodCl7ZCh0LHQuX3N0YXRlPVApfXZhciBiPXQuY29uZmlnLHg9KHQuY29uZmlndXJlLGUub2JqZWN0T3JGdW5jdGlvbiksRT1lLmlzRnVuY3Rpb24sVD0oZS5ub3csbi5jYXN0KSxDPXIuYWxsLGs9aS5yYWNlLEk9by5yZXNvbHZlLFM9cy5yZWplY3QsUj1hLmFzYXA7Yi5hc3luYz1SO3ZhciBPPXZvaWQgMCxCPTAsTT0xLFA9MjtoLnByb3RvdHlwZT17Y29uc3RydWN0b3I6aCxfc3RhdGU6dm9pZCAwLF9kZXRhaWw6dm9pZCAwLF9zdWJzY3JpYmVyczp2b2lkIDAsdGhlbjpmdW5jdGlvbih0LGUpe3ZhciBuPXRoaXMscj1uZXcgdGhpcy5jb25zdHJ1Y3RvcihmdW5jdGlvbigpe30pO2lmKHRoaXMuX3N0YXRlKXt2YXIgaT1hcmd1bWVudHM7Yi5hc3luYyhmdW5jdGlvbigpe3Aobi5fc3RhdGUscixpW24uX3N0YXRlLTFdLG4uX2RldGFpbCl9KX1lbHNlIGwodGhpcyxyLHQsZSk7cmV0dXJuIHJ9LCJjYXRjaCI6ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMudGhlbihudWxsLHQpfX0saC5hbGw9QyxoLmNhc3Q9VCxoLnJhY2U9ayxoLnJlc29sdmU9SSxoLnJlamVjdD1TLGMuUHJvbWlzZT1ofSksbigicHJvbWlzZS9yYWNlIixbIi4vdXRpbHMiLCJleHBvcnRzIl0sZnVuY3Rpb24odCxlKXsidXNlIHN0cmljdCI7ZnVuY3Rpb24gbih0KXt2YXIgZT10aGlzO2lmKCFyKHQpKXRocm93IG5ldyBUeXBlRXJyb3IoIllvdSBtdXN0IHBhc3MgYW4gYXJyYXkgdG8gcmFjZS4iKTtyZXR1cm4gbmV3IGUoZnVuY3Rpb24oZSxuKXtmb3IodmFyIHIsaT0wO2k8dC5sZW5ndGg7aSsrKXI9dFtpXSxyJiYiZnVuY3Rpb24iPT10eXBlb2Ygci50aGVuP3IudGhlbihlLG4pOmUocil9KX12YXIgcj10LmlzQXJyYXk7ZS5yYWNlPW59KSxuKCJwcm9taXNlL3JlamVjdCIsWyJleHBvcnRzIl0sZnVuY3Rpb24odCl7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIGUodCl7dmFyIGU9dGhpcztyZXR1cm4gbmV3IGUoZnVuY3Rpb24oZSxuKXtuKHQpfSl9dC5yZWplY3Q9ZX0pLG4oInByb21pc2UvcmVzb2x2ZSIsWyJleHBvcnRzIl0sZnVuY3Rpb24odCl7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIGUodCl7dmFyIGU9dGhpcztyZXR1cm4gbmV3IGUoZnVuY3Rpb24oZSl7ZSh0KX0pfXQucmVzb2x2ZT1lfSksbigicHJvbWlzZS91dGlscyIsWyJleHBvcnRzIl0sZnVuY3Rpb24odCl7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIGUodCl7cmV0dXJuIG4odCl8fCJvYmplY3QiPT10eXBlb2YgdCYmbnVsbCE9PXR9ZnVuY3Rpb24gbih0KXtyZXR1cm4iZnVuY3Rpb24iPT10eXBlb2YgdH1mdW5jdGlvbiByKHQpe3JldHVybiJbb2JqZWN0IEFycmF5XSI9PT1PYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodCl9dmFyIGk9RGF0ZS5ub3d8fGZ1bmN0aW9uKCl7cmV0dXJuKG5ldyBEYXRlKS5nZXRUaW1lKCl9O3Qub2JqZWN0T3JGdW5jdGlvbj1lLHQuaXNGdW5jdGlvbj1uLHQuaXNBcnJheT1yLHQubm93PWl9KSxyKCJwcm9taXNlL3BvbHlmaWxsIikucG9seWZpbGwoKX0oKSwiZnVuY3Rpb24iIT10eXBlb2YgT2JqZWN0LmNyZWF0ZXx8ImZ1bmN0aW9uIiE9dHlwZW9mIGUuY3JlYXRlRWxlbWVudCgiY2FudmFzIikuZ2V0Q29udGV4dClyZXR1cm4gdm9pZCh0Lmh0bWwyY2FudmFzPWZ1bmN0aW9uKCl7cmV0dXJuIFByb21pc2UucmVqZWN0KCJObyBjYW52YXMgc3VwcG9ydCIpfSk7dmFyIEVlPSJkYXRhLWh0bWwyY2FudmFzLW5vZGUiO3QuaHRtbDJjYW52YXM9ZnVuY3Rpb24oaSxvKXtvPW98fHt9LG8ubG9nZ2luZyYmKHQuaHRtbDJjYW52YXMubG9nZ2luZz0hMCx0Lmh0bWwyY2FudmFzLnN0YXJ0PURhdGUubm93KCkpLG8uYXN5bmM9InVuZGVmaW5lZCI9PXR5cGVvZiBvLmFzeW5jPyEwOm8uYXN5bmMsby5hbGxvd1RhaW50PSJ1bmRlZmluZWQiPT10eXBlb2Ygby5hbGxvd1RhaW50PyExOm8uYWxsb3dUYWludCxvLnJlbW92ZUNvbnRhaW5lcj0idW5kZWZpbmVkIj09dHlwZW9mIG8ucmVtb3ZlQ29udGFpbmVyPyEwOm8ucmVtb3ZlQ29udGFpbmVyO3ZhciBzPShpPT09bj9bZS5kb2N1bWVudEVsZW1lbnRdOmkubGVuZ3RoP2k6W2ldKVswXTtyZXR1cm4gcy5zZXRBdHRyaWJ1dGUoRWUsInRydWUiKSxyKHMub3duZXJEb2N1bWVudCxvLHQuaW5uZXJXaWR0aCx0LmlubmVySGVpZ2h0KS50aGVuKGZ1bmN0aW9uKHQpe3JldHVybiJmdW5jdGlvbiI9PXR5cGVvZiBvLm9ucmVuZGVyZWQmJihFKCJvcHRpb25zLm9ucmVuZGVyZWQgaXMgZGVwcmVjYXRlZCwgaHRtbDJjYW52YXMgcmV0dXJucyBhIFByb21pc2UgY29udGFpbmluZyB0aGUgY2FudmFzIiksby5vbnJlbmRlcmVkKHQpKSx0fSl9LGQucHJvdG90eXBlLmdldE1ldHJpY3M9ZnVuY3Rpb24odCxlKXtyZXR1cm4gdGhpcy5kYXRhW3QrIi0iK2VdPT09biYmKHRoaXMuZGF0YVt0KyItIitlXT1uZXcgbCh0LGUpKSx0aGlzLmRhdGFbdCsiLSIrZV19LGYucHJvdG90eXBlLlRZUEVTPXtMSU5FQVI6MSxSQURJQUw6Mn0sZi5wcm90b3R5cGUuYW5nbGVSZWdFeHA9LyhbKy1dP1xkKlwuP1xkKykoZGVnfGdyYWR8cmFkfHR1cm4pLyxtLnByb3RvdHlwZS5maW5kSW1hZ2VzPWZ1bmN0aW9uKHQpe3ZhciBlPVtdO3JldHVybiB0LmZpbHRlcih5KS5tYXAodykuZm9yRWFjaCh0aGlzLmFkZEltYWdlKGUsdGhpcy5sb2FkSW1hZ2UpLHRoaXMpLHQuZmlsdGVyKHYpLm1hcChiKS5mb3JFYWNoKHRoaXMuYWRkSW1hZ2UoZSx0aGlzLmxvYWRJbWFnZSksdGhpcyksZX0sbS5wcm90b3R5cGUuZmluZEJhY2tncm91bmRJbWFnZT1mdW5jdGlvbih0LGUpe3JldHVybiBlLnBhcnNlQmFja2dyb3VuZEltYWdlcygpLmZpbHRlcih0aGlzLmhhc0ltYWdlQmFja2dyb3VuZCkuZm9yRWFjaCh0aGlzLmFkZEltYWdlKHQsdGhpcy5sb2FkSW1hZ2UpLHRoaXMpLHR9LG0ucHJvdG90eXBlLmFkZEltYWdlPWZ1bmN0aW9uKHQsZSl7cmV0dXJuIGZ1bmN0aW9uKG4pe24uYXJncy5mb3JFYWNoKGZ1bmN0aW9uKHIpe3RoaXMuaW1hZ2VFeGlzdHModCxyKXx8KHQuc3BsaWNlKDAsMCxlLmNhbGwodGhpcyxuKSksRSgiQWRkZWQgaW1hZ2UgIyIrdC5sZW5ndGgsInN0cmluZyI9PXR5cGVvZiByP3Iuc3Vic3RyaW5nKDAsMTAwKTpyKSl9LHRoaXMpfX0sbS5wcm90b3R5cGUuaGFzSW1hZ2VCYWNrZ3JvdW5kPWZ1bmN0aW9uKHQpe3JldHVybiJub25lIiE9PXQubWV0aG9kfSxtLnByb3RvdHlwZS5sb2FkSW1hZ2U9ZnVuY3Rpb24odCl7aWYoInVybCI9PT10Lm1ldGhvZCl7dmFyIGU9dC5hcmdzWzBdO3JldHVybiF0aGlzLmlzU1ZHKGUpfHx0aGlzLnN1cHBvcnQuc3ZnfHx0aGlzLm9wdGlvbnMuYWxsb3dUYWludD9lLm1hdGNoKC9kYXRhOmltYWdlXC8uKjtiYXNlNjQsL2kpP25ldyBnKGUucmVwbGFjZSgvdXJsXChbJyciXXswLH18WycnIl17MCx9XCkkL2dpLCIiKSwhMSk6dGhpcy5pc1NhbWVPcmlnaW4oZSl8fHRoaXMub3B0aW9ucy5hbGxvd1RhaW50PT09ITB8fHRoaXMuaXNTVkcoZSk/bmV3IGcoZSwhMSk6dGhpcy5zdXBwb3J0LmNvcnMmJiF0aGlzLm9wdGlvbnMuYWxsb3dUYWludCYmdGhpcy5vcHRpb25zLnVzZUNPUlM/bmV3IGcoZSwhMCk6dGhpcy5vcHRpb25zLnByb3h5P25ldyB1ZShlLHRoaXMub3B0aW9ucy5wcm94eSk6bmV3IHAoZSk6bmV3IGZlKGUpfXJldHVybiJsaW5lYXItZ3JhZGllbnQiPT09dC5tZXRob2Q/bmV3IHgodCk6ImdyYWRpZW50Ij09PXQubWV0aG9kP25ldyB3ZSh0KToic3ZnIj09PXQubWV0aG9kP25ldyBtZSh0LmFyZ3NbMF0pOm5ldyBwKHQpfSxtLnByb3RvdHlwZS5pc1NWRz1mdW5jdGlvbih0KXtyZXR1cm4vKC4rKS5zdmckL2kudGVzdCh0KXx8ZmUucHJvdG90eXBlLmlzSW5saW5lKHQpfSxtLnByb3RvdHlwZS5pbWFnZUV4aXN0cz1mdW5jdGlvbih0LGUpe3JldHVybiB0LnNvbWUoZnVuY3Rpb24odCl7cmV0dXJuIHQuc3JjPT09ZX0pfSxtLnByb3RvdHlwZS5pc1NhbWVPcmlnaW49ZnVuY3Rpb24odCl7dmFyIG49dGhpcy5saW5rfHwodGhpcy5saW5rPWUuY3JlYXRlRWxlbWVudCgiYSIpKTtuLmhyZWY9dCxuLmhyZWY9bi5ocmVmO3ZhciByPW4ucHJvdG9jb2wrbi5ob3N0bmFtZStuLnBvcnQ7cmV0dXJuIHI9PT10aGlzLm9yaWdpbn0sbS5wcm90b3R5cGUuZ2V0UHJvbWlzZT1mdW5jdGlvbih0KXtyZXR1cm4gdC5wcm9taXNlfSxtLnByb3RvdHlwZS5nZXQ9ZnVuY3Rpb24odCl7dmFyIGU9bnVsbDtyZXR1cm4gdGhpcy5pbWFnZXMuc29tZShmdW5jdGlvbihuKXtyZXR1cm4oZT1uKS5zcmM9PT10fSk/ZTpudWxsfSxtLnByb3RvdHlwZS5mZXRjaD1mdW5jdGlvbih0KXtyZXR1cm4gdGhpcy5pbWFnZXM9dC5yZWR1Y2UoaWUodGhpcy5maW5kQmFja2dyb3VuZEltYWdlLHRoaXMpLHRoaXMuZmluZEltYWdlcyh0KSksdGhpcy5pbWFnZXMuZm9yRWFjaChmdW5jdGlvbih0LGUpe3QucHJvbWlzZS50aGVuKGZ1bmN0aW9uKCl7RSgiU3VjY2VzZnVsbHkgbG9hZGVkIGltYWdlICMiKyhlKzEpKX0sZnVuY3Rpb24oKXtFKCJGYWlsZWQgbG9hZGluZyBpbWFnZSAjIisoZSsxKSl9KX0pLHRoaXMucmVhZHk9UHJvbWlzZS5hbGwodGhpcy5pbWFnZXMubWFwKHRoaXMuZ2V0UHJvbWlzZSkpLEUoIkZpbmlzaGVkIHNlYXJjaGluZyBpbWFnZXMiKSx0aGlzfSx4LnByb3RvdHlwZT1PYmplY3QuY3JlYXRlKGYucHJvdG90eXBlKSx4LnByb3RvdHlwZS5zdGVwUmVnRXhwPS8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXHMqKFxkezEsM30pPyglfHB4KT8vLFQucHJvdG90eXBlLmFzc2lnblN0YWNrPWZ1bmN0aW9uKHQpe3RoaXMuc3RhY2s9dCx0LmNoaWxkcmVuLnB1c2godGhpcyl9LFQucHJvdG90eXBlLmlzRWxlbWVudFZpc2libGU9ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5ub2RlLm5vZGVUeXBlPT09Tm9kZS5URVhUX05PREU/dGhpcy5wYXJlbnQudmlzaWJsZToibm9uZSIhPT10aGlzLmNzcygiZGlzcGxheSIpJiYiaGlkZGVuIiE9PXRoaXMuY3NzKCJ2aXNpYmlsaXR5IikmJiF0aGlzLm5vZGUuaGFzQXR0cmlidXRlKCJkYXRhLWh0bWwyY2FudmFzLWlnbm9yZSIpfSxULnByb3RvdHlwZS5jc3M9ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMuY29tcHV0ZWRTdHlsZXN8fCh0aGlzLmNvbXB1dGVkU3R5bGVzPXRoaXMuY29tcHV0ZWRTdHlsZShudWxsKSksdGhpcy5zdHlsZXNbdF18fCh0aGlzLnN0eWxlc1t0XT10aGlzLmNvbXB1dGVkU3R5bGVzW3RdKX0sVC5wcm90b3R5cGUucHJlZml4ZWRDc3M9ZnVuY3Rpb24odCl7dmFyIGU9WyJ3ZWJraXQiLCJtb3oiLCJtcyIsIm8iXSxyPXRoaXMuY3NzKHQpO3JldHVybiByPT09biYmZS5zb21lKGZ1bmN0aW9uKGUpe3JldHVybiByPXRoaXMuY3NzKGUrdC5zdWJzdHIoMCwxKS50b1VwcGVyQ2FzZSgpK3Quc3Vic3RyKDEpKSxyIT09bn0sdGhpcykscj09PW4/bnVsbDpyfSxULnByb3RvdHlwZS5jb21wdXRlZFN0eWxlPWZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLm5vZGUub3duZXJEb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKHRoaXMubm9kZSx0KX0sVC5wcm90b3R5cGUuY3NzSW50PWZ1bmN0aW9uKHQpe3ZhciBlPXBhcnNlSW50KHRoaXMuY3NzKHQpLDEwKTtyZXR1cm4gaXNOYU4oZSk/MDplfSxULnByb3RvdHlwZS5jc3NGbG9hdD1mdW5jdGlvbih0KXt2YXIgZT1wYXJzZUZsb2F0KHRoaXMuY3NzKHQpKTtyZXR1cm4gaXNOYU4oZSk/MDplfSxULnByb3RvdHlwZS5mb250V2VpZ2h0PWZ1bmN0aW9uKCl7dmFyIHQ9dGhpcy5jc3MoImZvbnRXZWlnaHQiKTtzd2l0Y2gocGFyc2VJbnQodCwxMCkpe2Nhc2UgNDAxOnQ9ImJvbGQiO2JyZWFrO2Nhc2UgNDAwOnQ9Im5vcm1hbCJ9cmV0dXJuIHR9LFQucHJvdG90eXBlLnBhcnNlQmFja2dyb3VuZEltYWdlcz1mdW5jdGlvbigpe3JldHVybiB0aGlzLmJhY2tncm91bmRJbWFnZXN8fCh0aGlzLmJhY2tncm91bmRJbWFnZXM9Uyh0aGlzLmNzcygiYmFja2dyb3VuZEltYWdlIikpKX0sVC5wcm90b3R5cGUuY3NzTGlzdD1mdW5jdGlvbih0LGUpe3ZhciBuPSh0aGlzLmNzcyh0KXx8IiIpLnNwbGl0KCIsIik7cmV0dXJuIG49bltlfHwwXXx8blswXXx8ImF1dG8iLG49bi50cmltKCkuc3BsaXQoIiAiKSwxPT09bi5sZW5ndGgmJihuPVtuWzBdLG5bMF1dKSxufSxULnByb3RvdHlwZS5wYXJzZUJhY2tncm91bmRTaXplPWZ1bmN0aW9uKHQsZSxuKXt2YXIgcixpLG89dGhpcy5jc3NMaXN0KCJiYWNrZ3JvdW5kU2l6ZSIsbik7aWYoSShvWzBdKSlyPXQud2lkdGgqcGFyc2VGbG9hdChvWzBdKS8xMDA7ZWxzZXtpZigvY29udGFpbnxjb3Zlci8udGVzdChvWzBdKSl7dmFyIHM9dC53aWR0aC90LmhlaWdodCxhPWUud2lkdGgvZS5oZWlnaHQ7cmV0dXJuIGE+c14iY29udGFpbiI9PT1vWzBdP3t3aWR0aDp0LmhlaWdodCphLGhlaWdodDp0LmhlaWdodH06e3dpZHRoOnQud2lkdGgsaGVpZ2h0OnQud2lkdGgvYX19cj1wYXJzZUludChvWzBdLDEwKX1yZXR1cm4gaT0iYXV0byI9PT1vWzBdJiYiYXV0byI9PT1vWzFdP2UuaGVpZ2h0OiJhdXRvIj09PW9bMV0/ci9lLndpZHRoKmUuaGVpZ2h0Okkob1sxXSk/dC5oZWlnaHQqcGFyc2VGbG9hdChvWzFdKS8xMDA6cGFyc2VJbnQob1sxXSwxMCksImF1dG8iPT09b1swXSYmKHI9aS9lLmhlaWdodCplLndpZHRoKSx7d2lkdGg6cixoZWlnaHQ6aX19LFQucHJvdG90eXBlLnBhcnNlQmFja2dyb3VuZFBvc2l0aW9uPWZ1bmN0aW9uKHQsZSxuLHIpe3ZhciBpLG8scz10aGlzLmNzc0xpc3QoImJhY2tncm91bmRQb3NpdGlvbiIsbik7cmV0dXJuIGk9SShzWzBdKT8odC53aWR0aC0ocnx8ZSkud2lkdGgpKihwYXJzZUZsb2F0KHNbMF0pLzEwMCk6cGFyc2VJbnQoc1swXSwxMCksbz0iYXV0byI9PT1zWzFdP2kvZS53aWR0aCplLmhlaWdodDpJKHNbMV0pPyh0LmhlaWdodC0ocnx8ZSkuaGVpZ2h0KSpwYXJzZUZsb2F0KHNbMV0pLzEwMDpwYXJzZUludChzWzFdLDEwKSwiYXV0byI9PT1zWzBdJiYoaT1vL2UuaGVpZ2h0KmUud2lkdGgpLHtsZWZ0OmksdG9wOm99fSxULnByb3RvdHlwZS5wYXJzZUJhY2tncm91bmRSZXBlYXQ9ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMuY3NzTGlzdCgiYmFja2dyb3VuZFJlcGVhdCIsdClbMF19LFQucHJvdG90eXBlLnBhcnNlVGV4dFNoYWRvd3M9ZnVuY3Rpb24oKXt2YXIgdD10aGlzLmNzcygidGV4dFNoYWRvdyIpLGU9W107aWYodCYmIm5vbmUiIT09dClmb3IodmFyIG49dC5tYXRjaCh0aGlzLlRFWFRfU0hBRE9XX1BST1BFUlRZKSxyPTA7biYmcjxuLmxlbmd0aDtyKyspe3ZhciBpPW5bcl0ubWF0Y2godGhpcy5URVhUX1NIQURPV19WQUxVRVMpO2UucHVzaCh7Y29sb3I6aVswXSxvZmZzZXRYOmlbMV0/aVsxXS5yZXBsYWNlKCJweCIsIiIpOjAsb2Zmc2V0WTppWzJdP2lbMl0ucmVwbGFjZSgicHgiLCIiKTowLGJsdXI6aVszXT9pWzNdLnJlcGxhY2UoInB4IiwiIik6MH0pfXJldHVybiBlfSxULnByb3RvdHlwZS5wYXJzZVRyYW5zZm9ybT1mdW5jdGlvbigpe2lmKCF0aGlzLnRyYW5zZm9ybURhdGEpaWYodGhpcy5oYXNUcmFuc2Zvcm0oKSl7dmFyIHQ9dGhpcy5wYXJzZUJvdW5kcygpLGU9dGhpcy5wcmVmaXhlZENzcygidHJhbnNmb3JtT3JpZ2luIikuc3BsaXQoIiAiKS5tYXAoUikubWFwKE8pO2VbMF0rPXQubGVmdCxlWzFdKz10LnRvcCx0aGlzLnRyYW5zZm9ybURhdGE9e29yaWdpbjplLG1hdHJpeDp0aGlzLnBhcnNlVHJhbnNmb3JtTWF0cml4KCl9fWVsc2UgdGhpcy50cmFuc2Zvcm1EYXRhPXtvcmlnaW46WzAsMF0sbWF0cml4OlsxLDAsMCwxLDAsMF19O3JldHVybiB0aGlzLnRyYW5zZm9ybURhdGF9LFQucHJvdG90eXBlLnBhcnNlVHJhbnNmb3JtTWF0cml4PWZ1bmN0aW9uKCl7aWYoIXRoaXMudHJhbnNmb3JtTWF0cml4KXt2YXIgdD10aGlzLnByZWZpeGVkQ3NzKCJ0cmFuc2Zvcm0iKSxlPXQ/ayh0Lm1hdGNoKHRoaXMuTUFUUklYX1BST1BFUlRZKSk6bnVsbDt0aGlzLnRyYW5zZm9ybU1hdHJpeD1lP2U6WzEsMCwwLDEsMCwwXX1yZXR1cm4gdGhpcy50cmFuc2Zvcm1NYXRyaXh9LFQucHJvdG90eXBlLnBhcnNlQm91bmRzPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMuYm91bmRzfHwodGhpcy5ib3VuZHM9dGhpcy5oYXNUcmFuc2Zvcm0oKT9NKHRoaXMubm9kZSk6Qih0aGlzLm5vZGUpKX0sVC5wcm90b3R5cGUuaGFzVHJhbnNmb3JtPWZ1bmN0aW9uKCl7cmV0dXJuIjEsMCwwLDEsMCwwIiE9PXRoaXMucGFyc2VUcmFuc2Zvcm1NYXRyaXgoKS5qb2luKCIsIil8fHRoaXMucGFyZW50JiZ0aGlzLnBhcmVudC5oYXNUcmFuc2Zvcm0oKX0sVC5wcm90b3R5cGUuZ2V0VmFsdWU9ZnVuY3Rpb24oKXt2YXIgdD10aGlzLm5vZGUudmFsdWV8fCIiO3JldHVybiB0PSJTRUxFQ1QiPT09dGhpcy5ub2RlLnRhZ05hbWU/Qyh0aGlzLm5vZGUpOnQsMD09PXQubGVuZ3RoP3RoaXMubm9kZS5wbGFjZWhvbGRlcnx8IiI6dH0sVC5wcm90b3R5cGUuTUFUUklYX1BST1BFUlRZPS8obWF0cml4KVwoKC4rKVwpLyxULnByb3RvdHlwZS5URVhUX1NIQURPV19QUk9QRVJUWT0vKChyZ2JhfHJnYilcKFteXCldK1wpKFxzLT9cZCtweCl7MCx9KS9nLFQucHJvdG90eXBlLlRFWFRfU0hBRE9XX1ZBTFVFUz0vKC0/XGQrcHgpfCgjLispfChyZ2JcKC4rXCkpfChyZ2JhXCguK1wpKS9nLFAucHJvdG90eXBlLmFzeW5jUmVuZGVyZXI9ZnVuY3Rpb24odCxlLG4pe249bnx8RGF0ZS5ub3coKSx0aGlzLnBhaW50KHRbdGhpcy5yZW5kZXJJbmRleCsrXSksdC5sZW5ndGg9PT10aGlzLnJlbmRlckluZGV4P2UoKTpuKzIwPkRhdGUubm93KCk/dGhpcy5hc3luY1JlbmRlcmVyKHQsZSxuKTpzZXRUaW1lb3V0KGllKGZ1bmN0aW9uKCl7dGhpcy5hc3luY1JlbmRlcmVyKHQsZSl9LHRoaXMpLDApfSxQLnByb3RvdHlwZS5jcmVhdGVQc2V1ZG9IaWRlU3R5bGVzPWZ1bmN0aW9uKHQpe3ZhciBlPXQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTtlLmlubmVySFRNTD0iLiIrdGhpcy5wc2V1ZG9IaWRlQ2xhc3MrJyc6YmVmb3JlIHsgY29udGVudDogIiIgIWltcG9ydGFudDsgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OyB9LicnK3RoaXMucHNldWRvSGlkZUNsYXNzKycnOmFmdGVyIHsgY29udGVudDogIiIgIWltcG9ydGFudDsgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OyB9JycsdC5ib2R5LmFwcGVuZENoaWxkKGUpfSxQLnByb3RvdHlwZS5nZXRQc2V1ZG9FbGVtZW50cz1mdW5jdGlvbih0KXt2YXIgZT1bW3RdXTtpZih0Lm5vZGUubm9kZVR5cGU9PT1Ob2RlLkVMRU1FTlRfTk9ERSl7dmFyIG49dGhpcy5nZXRQc2V1ZG9FbGVtZW50KHQsIjpiZWZvcmUiKSxyPXRoaXMuZ2V0UHNldWRvRWxlbWVudCh0LCI6YWZ0ZXIiKTtuJiYodC5ub2RlLmluc2VydEJlZm9yZShuWzBdLm5vZGUsdC5ub2RlLmZpcnN0Q2hpbGQpLGUucHVzaChuKSksciYmKHQubm9kZS5hcHBlbmRDaGlsZChyWzBdLm5vZGUpLGUucHVzaChyKSksKG58fHIpJiYodC5ub2RlLmNsYXNzTmFtZSs9IiAiK3RoaXMucHNldWRvSGlkZUNsYXNzKX1yZXR1cm4gY2UoZSl9LFAucHJvdG90eXBlLmdldFBzZXVkb0VsZW1lbnQ9ZnVuY3Rpb24odCxuKXt2YXIgcj10LmNvbXB1dGVkU3R5bGUobik7aWYoIXJ8fCFyLmNvbnRlbnR8fCJub25lIj09PXIuY29udGVudHx8Ii1tb3otYWx0LWNvbnRlbnQiPT09ci5jb250ZW50fHwibm9uZSI9PT1yLmRpc3BsYXkpcmV0dXJuIG51bGw7Zm9yKHZhciBpPWhlKHIuY29udGVudCksbz0idXJsIj09PWkuc3Vic3RyKDAsMykscz1lLmNyZWF0ZUVsZW1lbnQobz8iaW1nIjoiaHRtbDJjYW52YXNwc2V1ZG9lbGVtZW50IiksYT1uZXcgVChzLHQpLGM9ci5sZW5ndGgtMTtjPj0wO2MtLSl7dmFyIGg9QShyLml0ZW0oYykpO3Muc3R5bGVbaF09cltoXX1pZihzLmNsYXNzTmFtZT10aGlzLnBzZXVkb0hpZGVDbGFzcyxvKXJldHVybiBzLnNyYz1TKGkpWzBdLmFyZ3NbMF0sW2FdO3ZhciB1PWUuY3JlYXRlVGV4dE5vZGUoaSk7cmV0dXJuIHMuYXBwZW5kQ2hpbGQodSksW2EsbmV3IHllKHUsYSldfSxQLnByb3RvdHlwZS5nZXRDaGlsZHJlbj1mdW5jdGlvbih0KXtyZXR1cm4gY2UoW10uZmlsdGVyLmNhbGwodC5ub2RlLmNoaWxkTm9kZXMsUSkubWFwKGZ1bmN0aW9uKGUpe3ZhciBuPVtlLm5vZGVUeXBlPT09Tm9kZS5URVhUX05PREU/bmV3IHllKGUsdCk6bmV3IFQoZSx0KV0uZmlsdGVyKGFlKTtyZXR1cm4gZS5ub2RlVHlwZT09PU5vZGUuRUxFTUVOVF9OT0RFJiZuLmxlbmd0aCYmIlRFWFRBUkVBIiE9PWUudGFnTmFtZT9uWzBdLmlzRWxlbWVudFZpc2libGUoKT9uLmNvbmNhdCh0aGlzLmdldENoaWxkcmVuKG5bMF0pKTpbXTpufSx0aGlzKSl9LFAucHJvdG90eXBlLm5ld1N0YWNraW5nQ29udGV4dD1mdW5jdGlvbih0LGUpe3ZhciBuPW5ldyBsZShlLHQuY3NzRmxvYXQoIm9wYWNpdHkiKSx0Lm5vZGUsdC5wYXJlbnQpO24udmlzaWJsZT10LnZpc2libGU7dmFyIHI9ZT9uLmdldFBhcmVudFN0YWNrKHRoaXMpOm4ucGFyZW50LnN0YWNrO3IuY29udGV4dHMucHVzaChuKSx0LnN0YWNrPW59LFAucHJvdG90eXBlLmNyZWF0ZVN0YWNraW5nQ29udGV4dHM9ZnVuY3Rpb24oKXt0aGlzLm5vZGVzLmZvckVhY2goZnVuY3Rpb24odCl7dGUodCkmJih0aGlzLmlzUm9vdEVsZW1lbnQodCl8fHJlKHQpfHxxKHQpfHx0aGlzLmlzQm9keVdpdGhUcmFuc3BhcmVudFJvb3QodCl8fHQuaGFzVHJhbnNmb3JtKCkpP3RoaXMubmV3U3RhY2tpbmdDb250ZXh0KHQsITApOnRlKHQpJiYoJCh0KSYmVih0KXx8Syh0KXx8Sih0KSk/dGhpcy5uZXdTdGFja2luZ0NvbnRleHQodCwhMSk6dC5hc3NpZ25TdGFjayh0LnBhcmVudC5zdGFjayl9LHRoaXMpfSxQLnByb3RvdHlwZS5pc0JvZHlXaXRoVHJhbnNwYXJlbnRSb290PWZ1bmN0aW9uKHQpe3JldHVybiJCT0RZIj09PXQubm9kZS5ub2RlTmFtZSYmdGhpcy5yZW5kZXJlci5pc1RyYW5zcGFyZW50KHQucGFyZW50LmNzcygiYmFja2dyb3VuZENvbG9yIikpfSxQLnByb3RvdHlwZS5pc1Jvb3RFbGVtZW50PWZ1bmN0aW9uKHQpe3JldHVybiBudWxsPT09dC5wYXJlbnR9LFAucHJvdG90eXBlLnNvcnRTdGFja2luZ0NvbnRleHRzPWZ1bmN0aW9uKHQpe3QuY29udGV4dHMuc29ydChuZSksdC5jb250ZXh0cy5mb3JFYWNoKHRoaXMuc29ydFN0YWNraW5nQ29udGV4dHMsdGhpcyl9LFAucHJvdG90eXBlLnBhcnNlVGV4dEJvdW5kcz1mdW5jdGlvbih0KXtyZXR1cm4gZnVuY3Rpb24oZSxuLHIpe2lmKCJub25lIiE9PXQucGFyZW50LmNzcygidGV4dERlY29yYXRpb24iKS5zdWJzdHIoMCw0KXx8MCE9PWUudHJpbSgpLmxlbmd0aCl7aWYodGhpcy5zdXBwb3J0LnJhbmdlQm91bmRzJiYhdC5wYXJlbnQuaGFzVHJhbnNmb3JtKCkpe3ZhciBpPXIuc2xpY2UoMCxuKS5qb2luKCIiKS5sZW5ndGg7cmV0dXJuIHRoaXMuZ2V0UmFuZ2VCb3VuZHModC5ub2RlLGksZS5sZW5ndGgpfWlmKHQubm9kZSYmInN0cmluZyI9PXR5cGVvZiB0Lm5vZGUuZGF0YSl7dmFyIG89dC5ub2RlLnNwbGl0VGV4dChlLmxlbmd0aCkscz10aGlzLmdldFdyYXBwZXJCb3VuZHModC5ub2RlLHQucGFyZW50Lmhhc1RyYW5zZm9ybSgpKTtyZXR1cm4gdC5ub2RlPW8sc319ZWxzZSghdGhpcy5zdXBwb3J0LnJhbmdlQm91bmRzfHx0LnBhcmVudC5oYXNUcmFuc2Zvcm0oKSkmJih0Lm5vZGU9dC5ub2RlLnNwbGl0VGV4dChlLmxlbmd0aCkpO3JldHVybnt9fX0sUC5wcm90b3R5cGUuZ2V0V3JhcHBlckJvdW5kcz1mdW5jdGlvbih0LGUpe3ZhciBuPXQub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCJodG1sMmNhbnZhc3dyYXBwZXIiKSxyPXQucGFyZW50Tm9kZSxpPXQuY2xvbmVOb2RlKCEwKTtuLmFwcGVuZENoaWxkKHQuY2xvbmVOb2RlKCEwKSksci5yZXBsYWNlQ2hpbGQobix0KTt2YXIgbz1lP00obik6QihuKTtyZXR1cm4gci5yZXBsYWNlQ2hpbGQoaSxuKSxvfSxQLnByb3RvdHlwZS5nZXRSYW5nZUJvdW5kcz1mdW5jdGlvbih0LGUsbil7dmFyIHI9dGhpcy5yYW5nZXx8KHRoaXMucmFuZ2U9dC5vd25lckRvY3VtZW50LmNyZWF0ZVJhbmdlKCkpO3JldHVybiByLnNldFN0YXJ0KHQsZSksci5zZXRFbmQodCxlK24pLHIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCl9LFAucHJvdG90eXBlLnBhcnNlPWZ1bmN0aW9uKHQpe3ZhciBlPXQuY29udGV4dHMuZmlsdGVyKEgpLG49dC5jaGlsZHJlbi5maWx0ZXIodGUpLHI9bi5maWx0ZXIoWihKKSksaT1yLmZpbHRlcihaKCQpKS5maWx0ZXIoWih6KSksbz1uLmZpbHRlcihaKCQpKS5maWx0ZXIoSikscz1yLmZpbHRlcihaKCQpKS5maWx0ZXIoeiksYT10LmNvbnRleHRzLmNvbmNhdChyLmZpbHRlcigkKSkuZmlsdGVyKFYpLGM9dC5jaGlsZHJlbi5maWx0ZXIoZWUpLmZpbHRlcihYKSxoPXQuY29udGV4dHMuZmlsdGVyKGopO2UuY29uY2F0KGkpLmNvbmNhdChvKS5jb25jYXQocykuY29uY2F0KGEpLmNvbmNhdChjKS5jb25jYXQoaCkuZm9yRWFjaChmdW5jdGlvbih0KXt0aGlzLnJlbmRlclF1ZXVlLnB1c2godCksWSh0KSYmKHRoaXMucGFyc2UodCksdGhpcy5yZW5kZXJRdWV1ZS5wdXNoKG5ldyBOKSl9LHRoaXMpfSxQLnByb3RvdHlwZS5wYWludD1mdW5jdGlvbih0KXt0cnl7dCBpbnN0YW5jZW9mIE4/dGhpcy5yZW5kZXJlci5jdHgucmVzdG9yZSgpOmVlKHQpP3RoaXMucGFpbnRUZXh0KHQpOnRoaXMucGFpbnROb2RlKHQpfWNhdGNoKGUpe0UoZSl9fSxQLnByb3RvdHlwZS5wYWludE5vZGU9ZnVuY3Rpb24odCl7WSh0KSYmKHRoaXMucmVuZGVyZXIuc2V0T3BhY2l0eSh0Lm9wYWNpdHkpLHRoaXMucmVuZGVyZXIuY3R4LnNhdmUoKSx0Lmhhc1RyYW5zZm9ybSgpJiZ0aGlzLnJlbmRlcmVyLnNldFRyYW5zZm9ybSh0LnBhcnNlVHJhbnNmb3JtKCkpKTt2YXIgZT10LnBhcnNlQm91bmRzKCksbj10aGlzLnBhcnNlQm9yZGVycyh0KTtzd2l0Y2godGhpcy5yZW5kZXJlci5jbGlwKG4uY2xpcCxmdW5jdGlvbigpe3RoaXMucmVuZGVyZXIucmVuZGVyQmFja2dyb3VuZCh0LGUsbi5ib3JkZXJzLm1hcChzZSkpfSx0aGlzKSx0aGlzLnJlbmRlcmVyLnJlbmRlckJvcmRlcnMobi5ib3JkZXJzKSx0Lm5vZGUubm9kZU5hbWUpe2Nhc2Uic3ZnIjp2YXIgcj10aGlzLmltYWdlcy5nZXQodC5ub2RlKTtyP3RoaXMucmVuZGVyZXIucmVuZGVySW1hZ2UodCxlLG4scik6RSgiRXJyb3IgbG9hZGluZyA8c3ZnPiIsdC5ub2RlKTticmVhaztjYXNlIklNRyI6dmFyIGk9dGhpcy5pbWFnZXMuZ2V0KHQubm9kZS5zcmMpO2k/dGhpcy5yZW5kZXJlci5yZW5kZXJJbWFnZSh0LGUsbixpKTpFKCJFcnJvciBsb2FkaW5nIDxpbWc+Iix0Lm5vZGUuc3JjKTticmVhaztjYXNlIlNFTEVDVCI6Y2FzZSJJTlBVVCI6Y2FzZSJURVhUQVJFQSI6dGhpcy5wYWludEZvcm1WYWx1ZSh0KX19LFAucHJvdG90eXBlLnBhaW50Rm9ybVZhbHVlPWZ1bmN0aW9uKHQpe2lmKHQuZ2V0VmFsdWUoKS5sZW5ndGg+MCl7dmFyIGU9dC5ub2RlLm93bmVyRG9jdW1lbnQsbj1lLmNyZWF0ZUVsZW1lbnQoImh0bWwyY2FudmFzd3JhcHBlciIpLHI9WyJsaW5lSGVpZ2h0IiwidGV4dEFsaWduIiwiZm9udEZhbWlseSIsImZvbnRXZWlnaHQiLCJmb250U2l6ZSIsImNvbG9yIiwicGFkZGluZ0xlZnQiLCJwYWRkaW5nVG9wIiwicGFkZGluZ1JpZ2h0IiwicGFkZGluZ0JvdHRvbSIsIndpZHRoIiwiaGVpZ2h0IiwiYm9yZGVyTGVmdFN0eWxlIiwiYm9yZGVyVG9wU3R5bGUiLCJib3JkZXJMZWZ0V2lkdGgiLCJib3JkZXJUb3BXaWR0aCIsImJveFNpemluZyIsIndoaXRlU3BhY2UiLCJ3b3JkV3JhcCJdO1wwMTJyLmZvckVhY2goZnVuY3Rpb24oZSl7dHJ5e24uc3R5bGVbZV09dC5jc3MoZSl9Y2F0Y2gocil7RSgiaHRtbDJjYW52YXM6IFBhcnNlOiBFeGNlcHRpb24gY2F1Z2h0IGluIHJlbmRlckZvcm1WYWx1ZTogIityLm1lc3NhZ2UpfX0pO3ZhciBpPXQucGFyc2VCb3VuZHMoKTtuLnN0eWxlLnBvc2l0aW9uPSJhYnNvbHV0ZSIsbi5zdHlsZS5sZWZ0PWkubGVmdCsicHgiLG4uc3R5bGUudG9wPWkudG9wKyJweCIsbi50ZXh0Q29udGVudD10LmdldFZhbHVlKCksZS5ib2R5LmFwcGVuZENoaWxkKG4pLHRoaXMucGFpbnRUZXh0KG5ldyB5ZShuLmZpcnN0Q2hpbGQsdCkpLGUuYm9keS5yZW1vdmVDaGlsZChuKX19LFAucHJvdG90eXBlLnBhaW50VGV4dD1mdW5jdGlvbih0KXt0LmFwcGx5VGV4dFRyYW5zZm9ybSgpO3ZhciBlPXQubm9kZS5kYXRhLnNwbGl0KCF0aGlzLm9wdGlvbnMubGV0dGVyUmVuZGVyaW5nfHxHKHQpPy8oXGJ8ICkvOiIiKSxuPXQucGFyZW50LmZvbnRXZWlnaHQoKSxyPXQucGFyZW50LmNzcygiZm9udFNpemUiKSxpPXQucGFyZW50LmNzcygiZm9udEZhbWlseSIpLG89dC5wYXJlbnQucGFyc2VUZXh0U2hhZG93cygpO3RoaXMucmVuZGVyZXIuZm9udCh0LnBhcmVudC5jc3MoImNvbG9yIiksdC5wYXJlbnQuY3NzKCJmb250U3R5bGUiKSx0LnBhcmVudC5jc3MoImZvbnRWYXJpYW50IiksbixyLGkpLG8ubGVuZ3RoP3RoaXMucmVuZGVyZXIuZm9udFNoYWRvdyhvWzBdLmNvbG9yLG9bMF0ub2Zmc2V0WCxvWzBdLm9mZnNldFksb1swXS5ibHVyKTp0aGlzLnJlbmRlcmVyLmNsZWFyU2hhZG93KCksZS5tYXAodGhpcy5wYXJzZVRleHRCb3VuZHModCksdGhpcykuZm9yRWFjaChmdW5jdGlvbihuLG8pe24mJih0aGlzLnJlbmRlcmVyLnRleHQoZVtvXSxuLmxlZnQsbi5ib3R0b20pLHRoaXMucmVuZGVyVGV4dERlY29yYXRpb24odC5wYXJlbnQsbix0aGlzLmZvbnRNZXRyaWNzLmdldE1ldHJpY3MoaSxyKSkpfSx0aGlzKX0sUC5wcm90b3R5cGUucmVuZGVyVGV4dERlY29yYXRpb249ZnVuY3Rpb24odCxlLG4pe3N3aXRjaCh0LmNzcygidGV4dERlY29yYXRpb24iKS5zcGxpdCgiICIpWzBdKXtjYXNlInVuZGVybGluZSI6dGhpcy5yZW5kZXJlci5yZWN0YW5nbGUoZS5sZWZ0LE1hdGgucm91bmQoZS50b3Arbi5iYXNlbGluZStuLmxpbmVXaWR0aCksZS53aWR0aCwxLHQuY3NzKCJjb2xvciIpKTticmVhaztjYXNlIm92ZXJsaW5lIjp0aGlzLnJlbmRlcmVyLnJlY3RhbmdsZShlLmxlZnQsTWF0aC5yb3VuZChlLnRvcCksZS53aWR0aCwxLHQuY3NzKCJjb2xvciIpKTticmVhaztjYXNlImxpbmUtdGhyb3VnaCI6dGhpcy5yZW5kZXJlci5yZWN0YW5nbGUoZS5sZWZ0LE1hdGguY2VpbChlLnRvcCtuLm1pZGRsZStuLmxpbmVXaWR0aCksZS53aWR0aCwxLHQuY3NzKCJjb2xvciIpKX19LFAucHJvdG90eXBlLnBhcnNlQm9yZGVycz1mdW5jdGlvbih0KXt2YXIgZT10LmJvdW5kcyxuPVUodCkscj1bIlRvcCIsIlJpZ2h0IiwiQm90dG9tIiwiTGVmdCJdLm1hcChmdW5jdGlvbihlKXtyZXR1cm57d2lkdGg6dC5jc3NJbnQoImJvcmRlciIrZSsiV2lkdGgiKSxjb2xvcjp0LmNzcygiYm9yZGVyIitlKyJDb2xvciIpLGFyZ3M6bnVsbH19KSxpPUQoZSxuLHIpO3JldHVybntjbGlwOnRoaXMucGFyc2VCYWNrZ3JvdW5kQ2xpcCh0LGkscixuLGUpLGJvcmRlcnM6ci5tYXAoZnVuY3Rpb24odCxvKXtpZih0LndpZHRoPjApe3ZhciBzPWUubGVmdCxhPWUudG9wLGM9ZS53aWR0aCxoPWUuaGVpZ2h0LXJbMl0ud2lkdGg7c3dpdGNoKG8pe2Nhc2UgMDpoPXJbMF0ud2lkdGgsdC5hcmdzPUYoe2MxOltzLGFdLGMyOltzK2MsYV0sYzM6W3MrYy1yWzFdLndpZHRoLGEraF0sYzQ6W3MrclszXS53aWR0aCxhK2hdfSxuWzBdLG5bMV0saS50b3BMZWZ0T3V0ZXIsaS50b3BMZWZ0SW5uZXIsaS50b3BSaWdodE91dGVyLGkudG9wUmlnaHRJbm5lcik7YnJlYWs7Y2FzZSAxOnM9ZS5sZWZ0K2Uud2lkdGgtclsxXS53aWR0aCxjPXJbMV0ud2lkdGgsdC5hcmdzPUYoe2MxOltzK2MsYV0sYzI6W3MrYyxhK2grclsyXS53aWR0aF0sYzM6W3MsYStoXSxjNDpbcyxhK3JbMF0ud2lkdGhdfSxuWzFdLG5bMl0saS50b3BSaWdodE91dGVyLGkudG9wUmlnaHRJbm5lcixpLmJvdHRvbVJpZ2h0T3V0ZXIsaS5ib3R0b21SaWdodElubmVyKTticmVhaztjYXNlIDI6YT1hK2UuaGVpZ2h0LXJbMl0ud2lkdGgsaD1yWzJdLndpZHRoLHQuYXJncz1GKHtjMTpbcytjLGEraF0sYzI6W3MsYStoXSxjMzpbcytyWzNdLndpZHRoLGFdLGM0OltzK2MtclszXS53aWR0aCxhXX0sblsyXSxuWzNdLGkuYm90dG9tUmlnaHRPdXRlcixpLmJvdHRvbVJpZ2h0SW5uZXIsaS5ib3R0b21MZWZ0T3V0ZXIsaS5ib3R0b21MZWZ0SW5uZXIpO2JyZWFrO2Nhc2UgMzpjPXJbM10ud2lkdGgsdC5hcmdzPUYoe2MxOltzLGEraCtyWzJdLndpZHRoXSxjMjpbcyxhXSxjMzpbcytjLGErclswXS53aWR0aF0sYzQ6W3MrYyxhK2hdfSxuWzNdLG5bMF0saS5ib3R0b21MZWZ0T3V0ZXIsaS5ib3R0b21MZWZ0SW5uZXIsaS50b3BMZWZ0T3V0ZXIsaS50b3BMZWZ0SW5uZXIpfX1yZXR1cm4gdH0pfX0sUC5wcm90b3R5cGUucGFyc2VCYWNrZ3JvdW5kQ2xpcD1mdW5jdGlvbih0LGUsbixyLGkpe3ZhciBvPXQuY3NzKCJiYWNrZ3JvdW5kQ2xpcCIpLHM9W107c3dpdGNoKG8pe2Nhc2UiY29udGVudC1ib3giOmNhc2UicGFkZGluZy1ib3giOlcocyxyWzBdLHJbMV0sZS50b3BMZWZ0SW5uZXIsZS50b3BSaWdodElubmVyLGkubGVmdCtuWzNdLndpZHRoLGkudG9wK25bMF0ud2lkdGgpLFcocyxyWzFdLHJbMl0sZS50b3BSaWdodElubmVyLGUuYm90dG9tUmlnaHRJbm5lcixpLmxlZnQraS53aWR0aC1uWzFdLndpZHRoLGkudG9wK25bMF0ud2lkdGgpLFcocyxyWzJdLHJbM10sZS5ib3R0b21SaWdodElubmVyLGUuYm90dG9tTGVmdElubmVyLGkubGVmdCtpLndpZHRoLW5bMV0ud2lkdGgsaS50b3AraS5oZWlnaHQtblsyXS53aWR0aCksVyhzLHJbM10sclswXSxlLmJvdHRvbUxlZnRJbm5lcixlLnRvcExlZnRJbm5lcixpLmxlZnQrblszXS53aWR0aCxpLnRvcCtpLmhlaWdodC1uWzJdLndpZHRoKTticmVhaztkZWZhdWx0OlcocyxyWzBdLHJbMV0sZS50b3BMZWZ0T3V0ZXIsZS50b3BSaWdodE91dGVyLGkubGVmdCxpLnRvcCksVyhzLHJbMV0sclsyXSxlLnRvcFJpZ2h0T3V0ZXIsZS5ib3R0b21SaWdodE91dGVyLGkubGVmdCtpLndpZHRoLGkudG9wKSxXKHMsclsyXSxyWzNdLGUuYm90dG9tUmlnaHRPdXRlcixlLmJvdHRvbUxlZnRPdXRlcixpLmxlZnQraS53aWR0aCxpLnRvcCtpLmhlaWdodCksVyhzLHJbM10sclswXSxlLmJvdHRvbUxlZnRPdXRlcixlLnRvcExlZnRPdXRlcixpLmxlZnQsaS50b3AraS5oZWlnaHQpfXJldHVybiBzfSxQLnByb3RvdHlwZS5wc2V1ZG9IaWRlQ2xhc3M9Il9fX2h0bWwyY2FudmFzX19fcHNldWRvZWxlbWVudCI7dmFyIFRlPTA7cGUucHJvdG90eXBlLnJlbmRlckltYWdlPWZ1bmN0aW9uKHQsZSxuLHIpe3ZhciBpPXQuY3NzSW50KCJwYWRkaW5nTGVmdCIpLG89dC5jc3NJbnQoInBhZGRpbmdUb3AiKSxzPXQuY3NzSW50KCJwYWRkaW5nUmlnaHQiKSxhPXQuY3NzSW50KCJwYWRkaW5nQm90dG9tIiksYz1uLmJvcmRlcnMsaD1lLndpZHRoLShjWzFdLndpZHRoK2NbM10ud2lkdGgraStzKSx1PWUuaGVpZ2h0LShjWzBdLndpZHRoK2NbMl0ud2lkdGgrbythKTt0aGlzLmRyYXdJbWFnZShyLDAsMCxyLmltYWdlLndpZHRofHxoLHIuaW1hZ2UuaGVpZ2h0fHx1LGUubGVmdCtpK2NbM10ud2lkdGgsZS50b3ArbytjWzBdLndpZHRoLGgsdSl9LHBlLnByb3RvdHlwZS5yZW5kZXJCYWNrZ3JvdW5kPWZ1bmN0aW9uKHQsZSxuKXtlLmhlaWdodD4wJiZlLndpZHRoPjAmJih0aGlzLnJlbmRlckJhY2tncm91bmRDb2xvcih0LGUpLHRoaXMucmVuZGVyQmFja2dyb3VuZEltYWdlKHQsZSxuKSl9LHBlLnByb3RvdHlwZS5yZW5kZXJCYWNrZ3JvdW5kQ29sb3I9ZnVuY3Rpb24odCxlKXt2YXIgbj10LmNzcygiYmFja2dyb3VuZENvbG9yIik7dGhpcy5pc1RyYW5zcGFyZW50KG4pfHx0aGlzLnJlY3RhbmdsZShlLmxlZnQsZS50b3AsZS53aWR0aCxlLmhlaWdodCx0LmNzcygiYmFja2dyb3VuZENvbG9yIikpfSxwZS5wcm90b3R5cGUucmVuZGVyQm9yZGVycz1mdW5jdGlvbih0KXt0LmZvckVhY2godGhpcy5yZW5kZXJCb3JkZXIsdGhpcyl9LHBlLnByb3RvdHlwZS5yZW5kZXJCb3JkZXI9ZnVuY3Rpb24odCl7dGhpcy5pc1RyYW5zcGFyZW50KHQuY29sb3IpfHxudWxsPT09dC5hcmdzfHx0aGlzLmRyYXdTaGFwZSh0LmFyZ3MsdC5jb2xvcil9LHBlLnByb3RvdHlwZS5yZW5kZXJCYWNrZ3JvdW5kSW1hZ2U9ZnVuY3Rpb24odCxlLG4pe3ZhciByPXQucGFyc2VCYWNrZ3JvdW5kSW1hZ2VzKCk7ci5yZXZlcnNlKCkuZm9yRWFjaChmdW5jdGlvbihyLGksbyl7c3dpdGNoKHIubWV0aG9kKXtjYXNlInVybCI6dmFyIHM9dGhpcy5pbWFnZXMuZ2V0KHIuYXJnc1swXSk7cz90aGlzLnJlbmRlckJhY2tncm91bmRSZXBlYXRpbmcodCxlLHMsby5sZW5ndGgtKGkrMSksbik6RSgiRXJyb3IgbG9hZGluZyBiYWNrZ3JvdW5kLWltYWdlIixyLmFyZ3NbMF0pO2JyZWFrO2Nhc2UibGluZWFyLWdyYWRpZW50IjpjYXNlImdyYWRpZW50Ijp2YXIgYT10aGlzLmltYWdlcy5nZXQoci52YWx1ZSk7YT90aGlzLnJlbmRlckJhY2tncm91bmRHcmFkaWVudChhLGUsbik6RSgiRXJyb3IgbG9hZGluZyBiYWNrZ3JvdW5kLWltYWdlIixyLmFyZ3NbMF0pO2JyZWFrO2Nhc2Uibm9uZSI6YnJlYWs7ZGVmYXVsdDpFKCJVbmtub3duIGJhY2tncm91bmQtaW1hZ2UgdHlwZSIsci5hcmdzWzBdKX19LHRoaXMpfSxwZS5wcm90b3R5cGUucmVuZGVyQmFja2dyb3VuZFJlcGVhdGluZz1mdW5jdGlvbih0LGUsbixyLGkpe3ZhciBvPXQucGFyc2VCYWNrZ3JvdW5kU2l6ZShlLG4uaW1hZ2Uscikscz10LnBhcnNlQmFja2dyb3VuZFBvc2l0aW9uKGUsbi5pbWFnZSxyLG8pLGE9dC5wYXJzZUJhY2tncm91bmRSZXBlYXQocik7c3dpdGNoKGEpe2Nhc2UicmVwZWF0LXgiOmNhc2UicmVwZWF0IG5vLXJlcGVhdCI6dGhpcy5iYWNrZ3JvdW5kUmVwZWF0U2hhcGUobixzLG8sZSxlLmxlZnQraVszXSxlLnRvcCtzLnRvcCtpWzBdLDk5OTk5LG4uaW1hZ2UuaGVpZ2h0LGkpO2JyZWFrO2Nhc2UicmVwZWF0LXkiOmNhc2Uibm8tcmVwZWF0IHJlcGVhdCI6dGhpcy5iYWNrZ3JvdW5kUmVwZWF0U2hhcGUobixzLG8sZSxlLmxlZnQrcy5sZWZ0K2lbM10sZS50b3AraVswXSxuLmltYWdlLndpZHRoLDk5OTk5LGkpO2JyZWFrO2Nhc2Uibm8tcmVwZWF0Ijp0aGlzLmJhY2tncm91bmRSZXBlYXRTaGFwZShuLHMsbyxlLGUubGVmdCtzLmxlZnQraVszXSxlLnRvcCtzLnRvcCtpWzBdLG4uaW1hZ2Uud2lkdGgsbi5pbWFnZS5oZWlnaHQsaSk7YnJlYWs7ZGVmYXVsdDp0aGlzLnJlbmRlckJhY2tncm91bmRSZXBlYXQobixzLG8se3RvcDplLnRvcCxsZWZ0OmUubGVmdH0saVszXSxpWzBdKX19LHBlLnByb3RvdHlwZS5pc1RyYW5zcGFyZW50PWZ1bmN0aW9uKHQpe3JldHVybiF0fHwidHJhbnNwYXJlbnQiPT09dHx8InJnYmEoMCwgMCwgMCwgMCkiPT09dH0sbGUucHJvdG90eXBlPU9iamVjdC5jcmVhdGUoVC5wcm90b3R5cGUpLGxlLnByb3RvdHlwZS5nZXRQYXJlbnRTdGFjaz1mdW5jdGlvbih0KXt2YXIgZT10aGlzLnBhcmVudD90aGlzLnBhcmVudC5zdGFjazpudWxsO3JldHVybiBlP2Uub3duU3RhY2tpbmc/ZTplLmdldFBhcmVudFN0YWNrKHQpOnQuc3RhY2t9LGRlLnByb3RvdHlwZS50ZXN0UmFuZ2VCb3VuZHM9ZnVuY3Rpb24odCl7dmFyIGUsbixyLGksbz0hMTtyZXR1cm4gdC5jcmVhdGVSYW5nZSYmKGU9dC5jcmVhdGVSYW5nZSgpLGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0JiYobj10LmNyZWF0ZUVsZW1lbnQoImJvdW5kdGVzdCIpLG4uc3R5bGUuaGVpZ2h0PSIxMjNweCIsbi5zdHlsZS5kaXNwbGF5PSJibG9jayIsdC5ib2R5LmFwcGVuZENoaWxkKG4pLGUuc2VsZWN0Tm9kZShuKSxyPWUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksaT1yLmhlaWdodCwxMjM9PT1pJiYobz0hMCksdC5ib2R5LnJlbW92ZUNoaWxkKG4pKSksb30sZGUucHJvdG90eXBlLnRlc3RDT1JTPWZ1bmN0aW9uKCl7cmV0dXJuInVuZGVmaW5lZCIhPXR5cGVvZihuZXcgSW1hZ2UpLmNyb3NzT3JpZ2lufSxkZS5wcm90b3R5cGUudGVzdFNWRz1mdW5jdGlvbigpe3ZhciB0PW5ldyBJbWFnZSxuPWUuY3JlYXRlRWxlbWVudCgiY2FudmFzIikscj1uLmdldENvbnRleHQoIjJkIik7dC5zcmM9ImRhdGE6aW1hZ2Uvc3ZnK3htbCw8c3ZnIHhtbG5zPScnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnJz48L3N2Zz4iO3RyeXtyLmRyYXdJbWFnZSh0LDAsMCksbi50b0RhdGFVUkwoKX1jYXRjaChpKXtyZXR1cm4hMX1yZXR1cm4hMH0sZmUucHJvdG90eXBlLmhhc0ZhYnJpYz1mdW5jdGlvbigpe3JldHVybiBodG1sMmNhbnZhcy5mYWJyaWM/UHJvbWlzZS5yZXNvbHZlKCk6UHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCJodG1sMmNhbnZhcy5zdmcuanMgaXMgbm90IGxvYWRlZCwgY2Fubm90IHJlbmRlciBzdmciKSl9LGZlLnByb3RvdHlwZS5pbmxpbmVGb3JtYXR0aW5nPWZ1bmN0aW9uKHQpe3JldHVybi9eZGF0YTppbWFnZVwvc3ZnXCt4bWw7YmFzZTY0LC8udGVzdCh0KT90aGlzLmRlY29kZTY0KHRoaXMucmVtb3ZlQ29udGVudFR5cGUodCkpOnRoaXMucmVtb3ZlQ29udGVudFR5cGUodCl9LGZlLnByb3RvdHlwZS5yZW1vdmVDb250ZW50VHlwZT1mdW5jdGlvbih0KXtyZXR1cm4gdC5yZXBsYWNlKC9eZGF0YTppbWFnZVwvc3ZnXCt4bWwoO2Jhc2U2NCk/LC8sIiIpfSxmZS5wcm90b3R5cGUuaXNJbmxpbmU9ZnVuY3Rpb24odCl7cmV0dXJuL15kYXRhOmltYWdlXC9zdmdcK3htbC9pLnRlc3QodCl9LGZlLnByb3RvdHlwZS5jcmVhdGVDYW52YXM9ZnVuY3Rpb24odCl7dmFyIGU9dGhpcztyZXR1cm4gZnVuY3Rpb24obixyKXt2YXIgaT1uZXcgaHRtbDJjYW52YXMuZmFicmljLlN0YXRpY0NhbnZhcygiYyIpO2UuaW1hZ2U9aS5sb3dlckNhbnZhc0VsLGkuc2V0V2lkdGgoci53aWR0aCkuc2V0SGVpZ2h0KHIuaGVpZ2h0KS5hZGQoaHRtbDJjYW52YXMuZmFicmljLnV0aWwuZ3JvdXBTVkdFbGVtZW50cyhuLHIpKS5yZW5kZXJBbGwoKSx0KGkubG93ZXJDYW52YXNFbCl9fSxmZS5wcm90b3R5cGUuZGVjb2RlNjQ9ZnVuY3Rpb24oZSl7cmV0dXJuImZ1bmN0aW9uIj09dHlwZW9mIHQuYXRvYj90LmF0b2IoZSk6Z2UoZSl9LG1lLnByb3RvdHlwZT1PYmplY3QuY3JlYXRlKGZlLnByb3RvdHlwZSkseWUucHJvdG90eXBlPU9iamVjdC5jcmVhdGUoVC5wcm90b3R5cGUpLHllLnByb3RvdHlwZS5hcHBseVRleHRUcmFuc2Zvcm09ZnVuY3Rpb24oKXt0aGlzLm5vZGUuZGF0YT10aGlzLnRyYW5zZm9ybSh0aGlzLnBhcmVudC5jc3MoInRleHRUcmFuc2Zvcm0iKSl9LHllLnByb3RvdHlwZS50cmFuc2Zvcm09ZnVuY3Rpb24odCl7dmFyIGU9dGhpcy5ub2RlLmRhdGE7c3dpdGNoKHQpe2Nhc2UibG93ZXJjYXNlIjpyZXR1cm4gZS50b0xvd2VyQ2FzZSgpO2Nhc2UiY2FwaXRhbGl6ZSI6cmV0dXJuIGUucmVwbGFjZSgvKF58XHN8OnwtfFwofFwpKShbYS16XSkvZyx2ZSk7Y2FzZSJ1cHBlcmNhc2UiOnJldHVybiBlLnRvVXBwZXJDYXNlKCk7ZGVmYXVsdDpyZXR1cm4gZX19LHdlLnByb3RvdHlwZT1PYmplY3QuY3JlYXRlKGYucHJvdG90eXBlKSx4ZS5wcm90b3R5cGU9T2JqZWN0LmNyZWF0ZShwZS5wcm90b3R5cGUpLHhlLnByb3RvdHlwZS5zZXRGaWxsU3R5bGU9ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMuY3R4LmZpbGxTdHlsZT10LHRoaXMuY3R4fSx4ZS5wcm90b3R5cGUucmVjdGFuZ2xlPWZ1bmN0aW9uKHQsZSxuLHIsaSl7dGhpcy5zZXRGaWxsU3R5bGUoaSkuZmlsbFJlY3QodCxlLG4scil9LHhlLnByb3RvdHlwZS5kcmF3U2hhcGU9ZnVuY3Rpb24odCxlKXt0aGlzLnNoYXBlKHQpLHRoaXMuc2V0RmlsbFN0eWxlKGUpLmZpbGwoKX0seGUucHJvdG90eXBlLnRhaW50cz1mdW5jdGlvbih0KXtpZihudWxsPT09dC50YWludGVkKXt0aGlzLnRhaW50Q3R4LmRyYXdJbWFnZSh0LmltYWdlLDAsMCk7dHJ5e3RoaXMudGFpbnRDdHguZ2V0SW1hZ2VEYXRhKDAsMCwxLDEpLHQudGFpbnRlZD0hMX1jYXRjaChuKXt0aGlzLnRhaW50Q3R4PWUuY3JlYXRlRWxlbWVudCgiY2FudmFzIikuZ2V0Q29udGV4dCgiMmQiKSx0LnRhaW50ZWQ9ITB9fXJldHVybiB0LnRhaW50ZWR9LHhlLnByb3RvdHlwZS5kcmF3SW1hZ2U9ZnVuY3Rpb24odCxlLG4scixpLG8scyxhLGMpeyghdGhpcy50YWludHModCl8fHRoaXMub3B0aW9ucy5hbGxvd1RhaW50KSYmdGhpcy5jdHguZHJhd0ltYWdlKHQuaW1hZ2UsZSxuLHIsaSxvLHMsYSxjKX0seGUucHJvdG90eXBlLmNsaXA9ZnVuY3Rpb24odCxlLG4pe3RoaXMuY3R4LnNhdmUoKSx0aGlzLnNoYXBlKHQpLmNsaXAoKSxlLmNhbGwobiksdGhpcy5jdHgucmVzdG9yZSgpfSx4ZS5wcm90b3R5cGUuc2hhcGU9ZnVuY3Rpb24odCl7cmV0dXJuIHRoaXMuY3R4LmJlZ2luUGF0aCgpLHQuZm9yRWFjaChmdW5jdGlvbih0LGUpe3RoaXMuY3R4WzA9PT1lPyJtb3ZlVG8iOnRbMF0rIlRvIl0uYXBwbHkodGhpcy5jdHgsdC5zbGljZSgxKSl9LHRoaXMpLHRoaXMuY3R4LmNsb3NlUGF0aCgpLHRoaXMuY3R4fSx4ZS5wcm90b3R5cGUuZm9udD1mdW5jdGlvbih0LGUsbixyLGksbyl7dGhpcy5zZXRGaWxsU3R5bGUodCkuZm9udD1bZSxuLHIsaSxvXS5qb2luKCIgIil9LHhlLnByb3RvdHlwZS5mb250U2hhZG93PWZ1bmN0aW9uKHQsZSxuLHIpe3RoaXMuc2V0VmFyaWFibGUoInNoYWRvd0NvbG9yIix0KS5zZXRWYXJpYWJsZSgic2hhZG93T2Zmc2V0WSIsZSkuc2V0VmFyaWFibGUoInNoYWRvd09mZnNldFgiLG4pLnNldFZhcmlhYmxlKCJzaGFkb3dCbHVyIixyKX0seGUucHJvdG90eXBlLmNsZWFyU2hhZG93PWZ1bmN0aW9uKCl7dGhpcy5zZXRWYXJpYWJsZSgic2hhZG93Q29sb3IiLCJyZ2JhKDAsMCwwLDApIil9LHhlLnByb3RvdHlwZS5zZXRPcGFjaXR5PWZ1bmN0aW9uKHQpe3RoaXMuY3R4Lmdsb2JhbEFscGhhPXR9LHhlLnByb3RvdHlwZS5zZXRUcmFuc2Zvcm09ZnVuY3Rpb24odCl7dGhpcy5jdHgudHJhbnNsYXRlKHQub3JpZ2luWzBdLHQub3JpZ2luWzFdKSx0aGlzLmN0eC50cmFuc2Zvcm0uYXBwbHkodGhpcy5jdHgsdC5tYXRyaXgpLHRoaXMuY3R4LnRyYW5zbGF0ZSgtdC5vcmlnaW5bMF0sLXQub3JpZ2luWzFdKX0seGUucHJvdG90eXBlLnNldFZhcmlhYmxlPWZ1bmN0aW9uKHQsZSl7cmV0dXJuIHRoaXMudmFyaWFibGVzW3RdIT09ZSYmKHRoaXMudmFyaWFibGVzW3RdPXRoaXMuY3R4W3RdPWUpLHRoaXN9LHhlLnByb3RvdHlwZS50ZXh0PWZ1bmN0aW9uKHQsZSxuKXt0aGlzLmN0eC5maWxsVGV4dCh0LGUsbil9LHhlLnByb3RvdHlwZS5iYWNrZ3JvdW5kUmVwZWF0U2hhcGU9ZnVuY3Rpb24odCxlLG4scixpLG8scyxhLGMpe3ZhciBoPVtbImxpbmUiLE1hdGgucm91bmQoaSksTWF0aC5yb3VuZChvKV0sWyJsaW5lIixNYXRoLnJvdW5kKGkrcyksTWF0aC5yb3VuZChvKV0sWyJsaW5lIixNYXRoLnJvdW5kKGkrcyksTWF0aC5yb3VuZChhK28pXSxbImxpbmUiLE1hdGgucm91bmQoaSksTWF0aC5yb3VuZChhK28pXV07dGhpcy5jbGlwKGgsZnVuY3Rpb24oKXt0aGlzLnJlbmRlckJhY2tncm91bmRSZXBlYXQodCxlLG4scixjWzNdLGNbMF0pfSx0aGlzKX0seGUucHJvdG90eXBlLnJlbmRlckJhY2tncm91bmRSZXBlYXQ9ZnVuY3Rpb24odCxlLG4scixpLG8pe3ZhciBzPU1hdGgucm91bmQoci5sZWZ0K2UubGVmdCtpKSxhPU1hdGgucm91bmQoci50b3ArZS50b3Arbyk7dGhpcy5zZXRGaWxsU3R5bGUodGhpcy5jdHguY3JlYXRlUGF0dGVybih0aGlzLnJlc2l6ZUltYWdlKHQsbiksInJlcGVhdCIpKSx0aGlzLmN0eC50cmFuc2xhdGUocyxhKSx0aGlzLmN0eC5maWxsKCksdGhpcy5jdHgudHJhbnNsYXRlKC1zLC1hKX0seGUucHJvdG90eXBlLnJlbmRlckJhY2tncm91bmRHcmFkaWVudD1mdW5jdGlvbih0LGUpe2lmKHQgaW5zdGFuY2VvZiB4KXt2YXIgbj10aGlzLmN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudChlLmxlZnQrZS53aWR0aCp0LngwLGUudG9wK2UuaGVpZ2h0KnQueTAsZS5sZWZ0K2Uud2lkdGgqdC54MSxlLnRvcCtlLmhlaWdodCp0LnkxKTt0LmNvbG9yU3RvcHMuZm9yRWFjaChmdW5jdGlvbih0KXtuLmFkZENvbG9yU3RvcCh0LnN0b3AsdC5jb2xvcil9KSx0aGlzLnJlY3RhbmdsZShlLmxlZnQsZS50b3AsZS53aWR0aCxlLmhlaWdodCxuKX19LHhlLnByb3RvdHlwZS5yZXNpemVJbWFnZT1mdW5jdGlvbih0LG4pe3ZhciByPXQuaW1hZ2U7aWYoci53aWR0aD09PW4ud2lkdGgmJnIuaGVpZ2h0PT09bi5oZWlnaHQpcmV0dXJuIHI7dmFyIGksbz1lLmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpO3JldHVybiBvLndpZHRoPW4ud2lkdGgsby5oZWlnaHQ9bi5oZWlnaHQsaT1vLmdldENvbnRleHQoIjJkIiksaS5kcmF3SW1hZ2UociwwLDAsci53aWR0aCxyLmhlaWdodCwwLDAsbi53aWR0aCxuLmhlaWdodCksb319KHdpbmRvdyxkb2N1bWVudCk7XDAxMlwwMTJcMDEyYXN5bmMgZnVuY3Rpb24gZ2V0U2NyZWVuU2hvdCgpe1wwMTIgICAgcmV0dXJuIGh0bWwyY2FudmFzKGRvY3VtZW50LmJvZHkpLnRoZW4oZnVuY3Rpb24oY2FudmFzKSB7XDAxMiAgICAgICAgcmV0dXJuIGNhbnZhcy50b0RhdGFVUkwoKTtcMDEyICAgIH0pO1wwMTJ9XDAxMicsJ1wwMTInLGNoYXIoMTApKSwxLCdzY3JlZW5zaG90Jywn5oiq5Zu+JywnYXdhaXQgZ2V0U2NyZWVuU2hvdCcsMSk7";
        db_init_sql += Buffer.from(module_import_b64_data, 'base64').toString("utf-8");
        db_init_sql += '\n';
    }
    try {
        const status = await process.env.DB.exec(db_init_sql).then((insert_result: any) => {
            if (insert_result.count >1) {
                return 1;
            } else {
                return -1;
            }
        });
        if (status != -1) {
            return true;
        } else {
            return false;
        }
    } catch (error) {
        return false;
    }
}


async function checkKVStatus() {
    try {
        await process.env.JSKV.put("test", "123456");
        if ("123456" == await process.env.JSKV.get("test")) {
            return true;
        }
        return false;
    }
    catch (error) {
        return false;
    }
}
async function checkDBStatus() {
    try {
        let db_result = await process.env.DB
            .prepare("SELECT 123456 AS test")
            .first().then((query_result: any) => {
                return query_result.test;
            });
        if (db_result == 123456) {
            return true;
        }
        return false;
    }
    catch (error) {
        return false;
    }
}
async function checkInstall() {
    let installStatus = false;
    try {
        let installed = await process.env.DB.prepare("SELECT configvalue FROM config WHERE configname = 'installed'")
            .first().then((query_result: any) => {
                return query_result.configvalue;
            });
        if (installed == 'installed') {
            installStatus = true;
        }
    } catch (error) {
        installStatus = false;
    }
    return installStatus;
}
function checkTokenSalt() {
    if (process.env.TOKEN_SALT != undefined && process.env.TOKEN_SALT.length >= 8) {
        return true;
    }
    return false;
}
function checkPasswordSalt() {
    if (process.env.PASSWORD_SALT != undefined && process.env.PASSWORD_SALT.length >= 8) {
        return true;
    }
    return false;
}

export async function handle(req: NextRequest) {
    const domainRegex = /^([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,63}(\/\S*)?$/;
    const usernameRegex = /^[a-zA-Z0-9]+$/;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    let error_message = [];
    let check_status = true;
    try {
        if(await checkInstall()){
            return new Response(
                JSON.stringify({
                    code: 400,
                    message: "系统已安装"
                }),
                {
                    status: 400,
                }
            );
        }
        if(!checkTokenSalt()){
            check_status = false;
            error_message.push("Token环境变量检测失败");
        }
        if(!checkPasswordSalt()){
            check_status = false;
            error_message.push("Password环境变量检测失败");
        }
        if(!(checkDBStatus())){
            check_status = false;
            error_message.push("DB绑定检测失败");
        }
        if(!(await checkKVStatus())){
            check_status = false;
            error_message.push("KV绑定检测失败");
        }
        const jsonData = await req.json();
        const domain = jsonData.domain;
        const module_import = jsonData.module_import;
        const username = jsonData.username;
        const password = await passwordHash(jsonData.password);
        const useremail = jsonData.useremail;
        if (!domain || typeof domain !== 'string' || !domain.match(domainRegex)) {
            check_status = false;
            error_message.push("请输入域名");
        }

        if (typeof module_import !== 'boolean') {
            check_status = false;
            error_message.push("导入推荐模块参数无效");
        }

        if (!username || typeof username !== 'string' || username.trim() === '') {
            check_status = false;
            error_message.push("请输入有效的用户名");
        }

        if (!password || typeof password !== 'string' || password.trim() === '') {
            check_status = false;
            error_message.push("请输入有效的密码");
        }
        if (!username.match(usernameRegex)) {
            check_status = false;
            error_message.push("用户名只能包含字母和数字");
        }
        if (password.length < 8) {
            check_status = false;
            error_message.push("密码长度错误");
        }
        if (!useremail.match(emailRegex)) {
            check_status = false;
            error_message.push("请输入有效的邮箱地址");
        }
        // 验证参数是否正确
        if (!check_status) {
            return new Response(
                JSON.stringify({
                    code: 400,
                    message: error_message.join(", ")
                }),
                {
                    status: 400,
                }
            );
        };


        if (await DBInitial(username, password, useremail,domain,module_import) == false) {
            return new Response(
                JSON.stringify({
                    code: 500,
                    message: "数据库初始化错误,请检查日志"
                }),
                {
                    status: 500,
                }
            );
        };

        // 无错误,进行完毕.
        return new Response(
            JSON.stringify({
                code: 200,
                message: "安装成功"
            }),
            {
                status: 200,
            }
        );
    }
    // 处理错误
    catch (e: any) {

        return new Response(
            JSON.stringify({
                code: 500,
                message: "服务器内部错误" + e.message
            }),
            {
                status: 500,
            }
        );
    }
}

export default handle;